create or replace package body                                                                acp_cohort_refresh as
 
  PROCEDURE PRINT_ERROR (v_proc_name varchar2, v_code number, v_errm varchar2) AS
  BEGIN 
    INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,COMMENTS) values (v_proc_name, sysdate, null, 'ERROR - Code: ' || v_code || '- ' || v_errm);
  END PRINT_ERROR;

-- Populate the Primary Care(PC) department list used on patient identification and Intervention logic
  PROCEDURE p_create_pc_department_tbl AS
   v_procname varchar2(100) := 'p_create_pc_department_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_DEPT_DRV(DEPARTMENT_ID NUMBER, LOC_ID number)
--                        ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT INTO XDR_ACP_DEPT_DRV
SELECT DISTINCT dep.DEPARTMENT_ID
            ,loc.loc_id
FROM clarity.CLARITY_DEP dep
left join clarity_loc    loc on dep.rev_loc_id = loc.loc_id
WHERE dep.DEPARTMENT_ID IN (
910314,
910310,
70085,
80366,
80039,
940035,
940043,
60155,
60156,
10511,
910227,
910228,
910230,
910231,
910177,
910178,
50541,
80273,
80279,
80114,
20511,
80169,
80179,
80044,
80382,
80329,
80049,
940012,
940013,
940015,
940016,
940017,
940018,
940019,
80087,
940038,
61026,
70001,
70009,
70003,
70005,
70006,
70007,
70008,
70010,
70011,
60678,
60679,
70079,
70032,
80168,
70034,
70035,
60152,
60153,
60159,
60160,
60161,
60162,
70080,
60167,
60170,
60173,
60175,
60176,
60177,
60178,
60180,
60181,
10009,
10014,
10030,
10031,
80399,
20560,
80000,
80368,
20570,
60079,
80337,
70186,
70190,
20561,
80379,
80372,
80071,
70232,
72005,
70210,
10501149,
80190,
80197,
60610,
60614,
60618,
60619,
60620,
60624,
60658,
60659,
60078,
60083,
10501190,
21200003,
21501001,
10501101,
80286,
80293,
60737,
60745,
70090,
70092,
70095,
20006,
20007,
20009,
70183,
70185,
80392,
20010,
70191,
20018,
80165,
20024,
80112,
80115,
70208,
70211,
70215,
70216,
80088,
80090,
30101101,
99102100,
70004,
80124,
80125,
80132,
80139,
80142,
80156,
80158,
80163,
80164,
80171,
60201,
80178,
72004,
72008,
80001,
80002,
80003,
80006,
80007,
80008,
80009,
80034,
80035,
80038,
80040,
80047,
80048,
80060,
80068,
--ADDED ON 01/04/20
80317,
80478,
80576
)'
    ;
    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_DEPT_DRV';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_DEPT_DRV', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_pc_department_tbl;


-- Populate a temporary Diagnosis driver table used on patient identification.
-- There is a driver file from which the insert statements were created (XDR_WALLING_DX_LOOKUP_TEMP.csv)
  PROCEDURE p_create_initial_diagnoses_tbl AS
   v_procname varchar2(100) := 'p_create_initial_diagnoses_table';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_DX_TEMP(ICD_CODE VARCHAR2(10 BYTE), DX_FLAG VARCHAR2(25 BYTE))
--ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL
INTO XDR_ACP_DX_TEMP VALUES(''155.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''155.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''155.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.1'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.11'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.12'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.13'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.14'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''Z99.1'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''Z99.11'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''Z99.12'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''J95.850'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.3'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.31'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.4'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.40'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.41'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.60'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.69'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''571.2'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''572.2'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''571.5'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''428.0'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.1'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.2'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.20'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.21'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.22'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.23'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.3'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.30'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.31'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.32'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.33'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.4'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.40'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.41'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.42'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.43'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''428.9'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''456.0'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''456.2'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''456.20'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''456.21'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''491.2'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''491.20'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''491.21'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''491.22'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''492.0'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''493.2'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''493.20'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''493.21'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''493.22'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''496'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''511.81'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''567.0'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.2'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.21'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.23'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.29'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.8'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.89'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''567.9'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''571.2'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''571.6'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''572.2'',''ENCEPHALOPATHY'')
INTO XDR_ACP_DX_TEMP VALUES(''572.4'',''HEPATORENAL'')
INTO XDR_ACP_DX_TEMP VALUES(''585.5'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''585.6'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''789.5'',''ASCITES'')
INTO XDR_ACP_DX_TEMP VALUES(''789.51'',''ASCITES'')
INTO XDR_ACP_DX_TEMP VALUES(''789.51'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''789.59'',''ASCITES'')
INTO XDR_ACP_DX_TEMP VALUES(''V42.0'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V45.1'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V45.11'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V45.12'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.0'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.1'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.2'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.3'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.31'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.32'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V56.8'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''C15.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C15.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C15.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C15.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C15.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C16.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C22.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C22.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C22.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C22.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C25.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C48.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C48.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C48.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C48.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C71.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.00'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.39'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C78.89'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.00'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.11'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.19'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.31'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.32'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.49'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.51'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.52'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.60'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.70'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.81'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.82'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.89'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C79.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C80.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.09'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.19'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.29'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.39'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.49'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.79'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C81.99'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C85.19'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C85.29'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C85.89'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.02'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.52'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.62'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.92'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C91.A2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C92.02'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C92.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''C95.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''G12.21'',''ALS'')
INTO XDR_ACP_DX_TEMP VALUES(''G20'',''PARKINSONS'')
INTO XDR_ACP_DX_TEMP VALUES(''G96.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''I09.81'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I11.0'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I13.0'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I13.2'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.1'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.9'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I85.01'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''I85.11'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''J43.9'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''J44.0'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''J44.1'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''J44.9'',''COPD'')
INTO XDR_ACP_DX_TEMP VALUES(''J91.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''K65.9'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K67'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.3'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.30'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.31'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.4'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.40'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K70.41'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K72.90'',''ENCEPHALOPATHY'')
INTO XDR_ACP_DX_TEMP VALUES(''K72.91'',''ENCEPHALOPATHY'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.3'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.4'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.5'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.60'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K74.69'',''CIRRHOSIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K76.7'',''HEPATORENAL'')
INTO XDR_ACP_DX_TEMP VALUES(''N18.5'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''N18.6'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''R18.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''R18.8'',''ASCITES'')
INTO XDR_ACP_DX_TEMP VALUES(''Z94.0'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''V46.2 '',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''Z99.81'',''COPD_SPO2'')
INTO XDR_ACP_DX_TEMP VALUES(''150'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''150.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''151.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''157.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''158.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''158.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''158.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''191.9'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''197.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.1'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.3'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.4'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.5'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.6'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.8'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.81'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.82'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''198.89'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''199.0'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.7'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.70'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.71'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.72'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.73'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.74'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.75'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.76'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.77'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''200.78'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.00'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.40'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.50'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.60'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.70'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''201.90'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''202.80'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''204.02'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''204.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''204.92'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''205.00'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''205.02'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''205.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''208.12'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''332.0'',''PARKINSONS'')
INTO XDR_ACP_DX_TEMP VALUES(''335.20'',''ALS'')
INTO XDR_ACP_DX_TEMP VALUES(''349.2'',''CANCER'')
INTO XDR_ACP_DX_TEMP VALUES(''398.91'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''402.01'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''402.11'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''402.91'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.01'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.03'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.11'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.13'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.91'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''404.93'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.21'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.20'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.22'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.23'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.30'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.31'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.32'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.33'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.40'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.41'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.42'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I50.43'',''CHF'')
INTO XDR_ACP_DX_TEMP VALUES(''I85.10'',''BLEEDING'')
INTO XDR_ACP_DX_TEMP VALUES(''K65.0'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K65.2'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''K65.8'',''PERITONITIS'')
INTO XDR_ACP_DX_TEMP VALUES(''Z99.2'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''Z91.15'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''Z49.31'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''Z49.01'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''Z49.02'',''ESRD'')
INTO XDR_ACP_DX_TEMP VALUES(''Z49.32'',''ESRD'')
SELECT 1 FROM DUAL'
    ;
    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_DX_TEMP';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_DX_TEMP', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_initial_diagnoses_tbl;



-- Populate final Diagnosis driver table used on patient identification
-- Match the ICd codes to their DX_ID using the EDG tables
  PROCEDURE p_create_final_diagnoses_tbl AS
   v_procname varchar2(100) := 'p_create_final_diagnoses_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_DX_LOOKUP(DX_ID NUMBER, ICD_CODE VARCHAR2(10 BYTE), DX_FLAG VARCHAR2(25 BYTE))
--ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT INTO XDR_ACP_DX_LOOKUP 
                        select edg.dx_id 
                        ,drv.* 
                        from XDR_ACP_DX_TEMP      drv 
                        join edg_current_icd9           edg on drv.icd_CODE = edg.CODE  
                        UNION 
                        select edg.dx_id 
                        ,drv.* 
                        from XDR_ACP_DX_TEMP      drv 
                        join edg_current_icd10           edg on drv.icd_CODE = edg.CODE'
    ;
    commit;   
-- create index
--EXECUTE IMMEDIATE  'create index XDR_ACP_DX_LOOKUP_id_dx_id on XDR_ACP_DX_LOOKUP(dx_id)';
--    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_DX_LOOKUP';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_DX_LOOKUP', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_final_diagnoses_tbl;

-- Populate the Patient Status driver used on patient identification to exclude
-- test/dummy and other 'not real' patients from the cohort
  PROCEDURE p_create_pat_status_tbl AS
   v_procname varchar2(100) := 'p_create_pat_status_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_PAT_STATUS(PAT_FLAG_TYPE_C NUMBER) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL 
                            INTO XDR_ACP_PAT_STATUS VALUES(6) 
                            INTO XDR_ACP_PAT_STATUS VALUES(8) 
                            INTO XDR_ACP_PAT_STATUS VALUES(9) 
                            INTO XDR_ACP_PAT_STATUS VALUES(1018) 
                            INTO XDR_ACP_PAT_STATUS VALUES(1017) 
                            SELECT 1 FROM DUAL';
    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_PAT_STATUS';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PAT_STATUS', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_pat_status_tbl;

-- Populate the Appointment Status driver used on patient identification to exclude
-- invalid encounters when chekcing the +1 PC criteria
PROCEDURE p_create_appt_status_tbl AS
   v_procname varchar2(100) := 'p_create_appt_status_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_APPT_STATUS(appt_status_c NUMBER, appt_cat VARCHAR2(25 BYTE)) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL 
                        INTO XDR_ACP_APPT_STATUS VALUES(1,''include'') 
                        INTO XDR_ACP_APPT_STATUS VALUES(3,''exclude'') 
                        INTO XDR_ACP_APPT_STATUS VALUES(4,''exclude'') 
                        INTO XDR_ACP_APPT_STATUS VALUES(5,''exclude'') 
                        SELECT 1 FROM DUAL';
    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_APPT_STATUS';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_APPT_STATUS', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_appt_status_tbl;

-- Populate the Chemotherapy CPT driver table used on patient identification for Cancer
  PROCEDURE p_create_cpt_chemo_tbl AS
   v_procname varchar2(100) := 'p_create_cpt_chemo_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_CHEMO_CPT(CPT_CODE VARCHAR2(25 BYTE)) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL 
INTO XDR_ACP_CHEMO_CPT VALUES(96401)
INTO XDR_ACP_CHEMO_CPT VALUES(96402)
INTO XDR_ACP_CHEMO_CPT VALUES(96405)
INTO XDR_ACP_CHEMO_CPT VALUES(96406)
INTO XDR_ACP_CHEMO_CPT VALUES(96409)
INTO XDR_ACP_CHEMO_CPT VALUES(96411)
INTO XDR_ACP_CHEMO_CPT VALUES(96413)
INTO XDR_ACP_CHEMO_CPT VALUES(96415)
INTO XDR_ACP_CHEMO_CPT VALUES(96416)
INTO XDR_ACP_CHEMO_CPT VALUES(96417)
INTO XDR_ACP_CHEMO_CPT VALUES(96423)
INTO XDR_ACP_CHEMO_CPT VALUES(96420)
INTO XDR_ACP_CHEMO_CPT VALUES(96422)
INTO XDR_ACP_CHEMO_CPT VALUES(96425)
INTO XDR_ACP_CHEMO_CPT VALUES(96440)
INTO XDR_ACP_CHEMO_CPT VALUES(96446)
INTO XDR_ACP_CHEMO_CPT VALUES(96450) 
SELECT 1 FROM DUAL';
    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_CHEMO_CPT';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_CHEMO_CPT', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_cpt_chemo_tbl;

-- Populate the Appointment Type driver table
-- Some are used only for counting the PC encounters, 
-- and others on the Appointment for the Intervention trigger logic
    PROCEDURE p_create_appt_type_tbl AS
   v_procname varchar2(100) := 'p_create_appt_type_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_APPT_TYPE(PRC_ID VARCHAR2(50 BYTE)) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert recordsf
    EXECUTE IMMEDIATE  'INSERT ALL 
INTO XDR_ACP_APPT_TYPE VALUES(''2001'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2009'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2008'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2000'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4640'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2007'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2133'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4497'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2214'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4201'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4639'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4641'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4642'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4653'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2858'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3499'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2553'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331238'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4644'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2848'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4728'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4682'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''1002'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4945'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2006'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2066'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4199'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4605'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3509'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4271'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4376'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330543'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4583'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4655'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4210'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4848'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4657'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2014'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4652'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4654'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331409'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331322'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2004'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4582'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2211'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''10143'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2867'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4185'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3447'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4681'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4683'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2010'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331009'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5009'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331406'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2839'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331742'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4633'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331226'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4495'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4686'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4403'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331052'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4684'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2131'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3462'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4626'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4270'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3448'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331528'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2854'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4433'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4460'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''334010'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2857'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331195'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3394'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4849'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332607'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331286'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332481'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2850'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4189'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331342'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4680'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4738'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331401'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4222'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4707'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2015'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332628'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4264'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331259'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4481'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2939'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4635'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4662'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''335392'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4409'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331024'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331057'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331077'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5068'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331384'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331497'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4259'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5069'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331189'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4411'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4632'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4616'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4272'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330933'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4176'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4650'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''334794'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331103'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4645'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4209'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4192'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4142'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4371'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4599'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332447'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4663'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4459'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''334782'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3391'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4634'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4940'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3826'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2847'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331088'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5331'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331055'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4628'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''1032'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5332'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4416'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2005'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4637'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4462'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5026'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4461'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4190'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4464'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4421'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4434'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4186'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331787'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4065'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331087'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4661'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2002'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2074'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2071'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4627'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2018'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331053'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4700'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4630'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4435'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4482'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4285'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4699'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5834'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4064'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4625'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''333182'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333270'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''10189'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2063'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4194'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4726'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3333'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2085'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4701'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4415'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4704'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2011'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332625'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4198'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331349'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4676'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5236'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4278'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333271'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331173'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331348'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4067'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4665'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4878'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332942'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4208'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4063'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332489'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''1129'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331062'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2837'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2863'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330563'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332488'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4360'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3353'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331809'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2855'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4709'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4679'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4664'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4706'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2088'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5773'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4973'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332491'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4311'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4130'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4972'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4280'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3349'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4282'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331501'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4708'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3390'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331217'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3477'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330542'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331317'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5522'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3605'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4743'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4273'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2070'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4410'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4300'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331340'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331093'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331526'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4187'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2859'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331100'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2874'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4412'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4068'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4711'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331282'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2877'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331004'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331509'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331243'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331028'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4438'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331264'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330540'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5772'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4281'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331081'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331291'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4702'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4129'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3392'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2830'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5066'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''333129'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3467'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333177'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4196'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2083'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4957'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3418'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3246'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4450'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5028'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332615'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4191'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''335984'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331026'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5053'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4449'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4066'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2840'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5776'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4436'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''528'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5541'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''21070007'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3393'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4725'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333178'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332595'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331403'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4615'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5540'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4275'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331304'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4188'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4370'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4319'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2838'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4265'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4069'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5519'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2598'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4658'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3295'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2710'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331788'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2856'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331290'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4648'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332583'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4687'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331287'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2017'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3324'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4496'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331327'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4554'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4611'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5088'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5054'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5238'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2851'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4843'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4474'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4643'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330145'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331214'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3331'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4631'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2013'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4413'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4581'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330005'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330003'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4448'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2626'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331368'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333543'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332588'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2016'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5521'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2111'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4619'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2599'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331351'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332631'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330571'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331726'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4262'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333423'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2618'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2881'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2616'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4428'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331319'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333549'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331786'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4418'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2216'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2864'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330905'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''334802'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331386'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331309'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333087'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331375'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331138'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2082'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333220'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4729'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331160'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331305'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330124'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5172'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331220'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333224'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331066'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2940'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331272'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''10147'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4149'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4796'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331370'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331316'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331139'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2067'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331810'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4532'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2597'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2938'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331202'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4174'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4584'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331223'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331328'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4473'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331324'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331037'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4207'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2624'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4195'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3330'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331268'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331374'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331276'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333137'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5771'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332575'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331508'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5237'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331281'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4359'',1,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331381'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330286'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332952'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4417'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4607'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3733'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4580'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331289'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333298'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330544'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331174'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331362'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2969'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4178'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331383'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''10144'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332442'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331255'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331364'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333343'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331343'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331068'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332482'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5535'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4846'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''333261'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331262'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331050'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331208'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4620'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4269'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331043'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4423'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331344'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2544'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4452'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4614'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4938'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5239'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4742'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3606'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331279'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3592'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4419'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331299'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3476'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''332576'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331261'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331365'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4939'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331047'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331308'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331330'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331071'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4951'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4691'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4274'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331345'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2831'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330326'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4797'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4463'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5303'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332256'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331064'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3355'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331041'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331361'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5241'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331390'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331036'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4623'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330904'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332448'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333341'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''335728'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4621'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''330552'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330898'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2209'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''331072'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2910'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331303'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4690'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4844'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5482'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4618'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4608'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3513'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4414'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5233'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''10141'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333272'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2833'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5183'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331175'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331355'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''10192'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332609'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''336163'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5089'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2081'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''3625'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2884'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5304'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''332645'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330910'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5774'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4429'',0,1)
INTO XDR_ACP_APPT_TYPE VALUES(''333110'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331346'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5809'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''333545'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4277'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''4539'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331499'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''330938'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''2835'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331333'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5034'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''5111'',0,0)
INTO XDR_ACP_APPT_TYPE VALUES(''331310'',0,0)
--TELEMEDICINE-TELEPHONE
INTO XDR_ACP_APPT_TYPE VALUES(''5171'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5174'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''6066'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3603'',1,1)
--AFTER COHORT POP CONSOLIDATION
INTO XDR_ACP_APPT_TYPE VALUES(''4179'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5182'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5819'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4668'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4669'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4667'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4670'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4672'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''5184'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4674'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''2003'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4609'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''3468'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4610'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4197'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4673'',1,1)
INTO XDR_ACP_APPT_TYPE VALUES(''4649'',1,1)
--after investigation on primary care visits for Dr Takada (Zoom video)
INTO XDR_ACP_APPT_TYPE VALUES(''6083'',1,1) 
INTO XDR_ACP_APPT_TYPE VALUES(''6082'',1,1) 
SELECT 1 FROM DUAL';
    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_APPT_TYPE';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_APPT_TYPE', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;


    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_appt_type_tbl;

----------------------------------------------------
-- The PC clinic table driver was ultimately turned into a permanent query for reporting purposes
----------------------------------------------------
--PROCEDURE p_create_clinic_tbl AS
--   v_procname varchar2(100) := 'p_create_clinic_tbl';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--
--    --- update dash_etl_log with record count prior to truncate 
----    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;
--
--    --Create table 
----    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_CLINICS(CLINIC_ID NUMBER(18,0),COORDINATOR_ID VARCHAR2(128 BYTE)) ON COMMIT PRESERVE ROWS';
----    commit;   
--
--    --Insert records
--    EXECUTE IMMEDIATE  'INSERT ALL 
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7083,''MORRISSEY, KIRA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7000,''TAGAYUN, MARIE'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8082,''SPENCER BAEZ, RAYMOND'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8006,''LEGASPI, SHEILA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(1675,''RAMIREZ, SHARON'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6016,''KAUR, HARMANDEEP'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6017,''MEDINA, ARMANDO'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7084,''LOPEZ, CLAUDIA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8182,''AISPURO, VANESSA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7025,''VALENCIA, APRIL'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7083,''KAUR, HARMANDEEP'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8084,''SPENCER BAEZ, RAYMOND'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6000,''BASCOS, ELAINE'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7014,''AISPURO, VANESSA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7023,''FERNANDEZ, THEA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8151,''FERNANDEZ, THEA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(1846,''GARCIA, EVELYN'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6017,''CRAIGEN, SENITA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(1847,''LEGASPI, SHEILA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6017,''KWAN, ERIC'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8008,''AISPURO, VANESSA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7021,''AISPURO, VANESSA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7024,''LUA, PATRICIA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6017,''NOEL, KEVIN'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7011,''LANDAVERDE, LISETTE'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7008,''LUA, PATRICIA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8010,''LOPEZ, CLAUDIA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7007,''TROTTER, ALDOUS'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8002,''SANDOVAL, JESSICA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8022,''SPENCER BAEZ, RAYMOND'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7046,''RODRIGUEZ, DARLENE'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(7000,''KAUR, HARMANDEEP'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6020,''CRAIGEN, SENITA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6004,''MEDINA, ARMANDO'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8000,''TROTTER, ALDOUS'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(2455,''AISPURO, VANESSA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(8092,''GARCIA, EVELYN'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6016,''MORRISSEY, KIRA'')
--INTO XDR_ACP_CLINICS (CLINIC_ID,COORDINATOR_ID) VALUES(6002,''BASCOS, ELAINE'') 
--SELECT 1 FROM DUAL';
--    commit;   
----- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_CLINICS';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_CLINICS', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
--      commit;
--
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--
--  END p_create_clinic_tbl;


-- Populate the Advaced Directive /POLST driver table
-- These are site specific and shall require other sites to investigate and 
-- locate their own codes
PROCEDURE p_create_adpolst_driver_tbl AS
   v_procname varchar2(100) := 'p_create_adpolst_driver_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_ADPOLST_DRV("DOC_INFO_TYPE_C" VARCHAR2(10),"DOC_GROUP" VARCHAR2(10)) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL 
INTO XDR_ACP_ADPOLST_DRV VALUES(''11'',''AD'')
INTO XDR_ACP_ADPOLST_DRV VALUES(''300052'',''AD'')
INTO XDR_ACP_ADPOLST_DRV VALUES(''10'',''AD'')
INTO XDR_ACP_ADPOLST_DRV VALUES(''200068'',''POLST'')
INTO XDR_ACP_ADPOLST_DRV VALUES(''300058'',''POLST'') 
SELECT 1 FROM DUAL';
    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_ADPOLST_DRV';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_ADPOLST_DRV', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_adpolst_driver_tbl;


-- Populate the Advaced Directive /POLST driver table
-- These are site specific and shall require other sites to investigate and 
-- locate their own codes
PROCEDURE p_create_record_tbl AS
   v_procname varchar2(100) := 'p_create_record_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_RECORD_STATE("RECORD_STATE_C" NUMBER) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL  
                        INTO XDR_ACP_RECORD_STATE VALUES(2) 
                        SELECT 1 FROM DUAL';
    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_RECORD_STATE';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RECORD_STATE', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;


    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_record_tbl;

PROCEDURE p_create_DOC_STATUS_tbl AS
   v_procname varchar2(100) := 'p_create_DOC_STATUS_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_DOC_STATUS("DOC_STAT_C" NUMBER) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT INTO XDR_ACP_DOC_STATUS  
SELECT DOC_STAT_C 
FROM ZC_DOC_STAT 
WHERE DOC_STAT_C = 35';
    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_DOC_STATUS';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_DOC_STATUS', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_DOC_STATUS_tbl;


PROCEDURE p_create_lab_drv_tbl AS
   v_procname varchar2(100) := 'p_create_lab_drv_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE "CTSI_RESEARCH"."XDR_ACP_LAB_DRV" 
--   (	"PROC_ID" NUMBER, 
--	"COMPONENT_ID" NUMBER, 
--	"LAB_CATEGORY" VARCHAR2(25 BYTE),
--    "LOINC_CODE" VARCHAR2(50 BYTE)
--   ) ON COMMIT PRESERVE ROWS';
--    commit;   

    --Insert records
    EXECUTE IMMEDIATE  'INSERT ALL 
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105313,2476,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,8001545,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(720516,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12312,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12312,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83970,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83970,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,8001531,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(281469,3005980,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105109,2381,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(892,8001484,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(680,8001484,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83970,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,8001549,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10020051,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83974,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,8001484,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,8001545,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327246,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(76139,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83974,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(721807,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(721807,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(165000000,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,10010540,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105183,2382,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98225,8001486,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(892,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725882,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(57423,3004397,''CREATININE'',''38483-4'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(247602,1526776,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725898,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105117,2485,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105325,2485,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105297,2486,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98223,8001550,''BILIRUBIN'',''15152-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,1526296,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(78045,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(743966,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105271,2432,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,8001531,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105181,2381,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(23267,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(245307,8001490,''SODIUM'',''1994-3'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105191,2386,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10020000,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105119,2477,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98223,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(748,10020051,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(165000000,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725683,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,8001522,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(60938,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(304770,10001157,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(680,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327246,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725866,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(303647,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327261,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,10020029,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(17421,10010148,''BILIRUBIN'',''1968-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(721807,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(680,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(21289,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(743966,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,8001522,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105117,2450,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,8000225,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(103773,523,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105169,2381,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105185,2383,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105187,2386,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725898,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83970,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,8001531,''ALBUMIN'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(165000000,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725882,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327246,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725882,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(304776,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1620,1553372,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,10001157,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98225,8001485,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83974,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,8001484,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725765,10010540,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(165000000,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(892,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(76139,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,8001545,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105295,2476,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,8001546,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(78220,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(23267,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,8001550,''BILIRUBIN'',''15152-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105107,2450,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105121,2451,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(245333,8001520,''CREATININE'',''38483-4'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105273,2433,''CREATININE'',''38483-4'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(103767,518,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(10278,1511118,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105117,2381,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,8001484,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(743966,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(78220,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(17421,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105327,2486,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(90626,8001550,''BILIRUBIN'',''15152-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,3000387,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(305100,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(23267,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10020000,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(16500000,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(748,3000387,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98223,3000387,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10020051,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(10274,1511105,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10020018,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327250,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327261,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(165000000,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1620,3003794,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(680,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(245307,3003748,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10020050,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(721807,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725922,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10020050,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(23267,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,8001486,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(90544,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(17421,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(743966,10000318,''BILIRUBIN'',''5770-3'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(743966,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105295,2485,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327246,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105123,2477,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,3005513,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,3000387,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(720516,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(16500000,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98221,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(76139,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(109390,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725683,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105173,2382,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(892,10020050,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(109390,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(9956,3005974,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327250,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725683,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105109,2476,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105117,2476,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,1810650,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105119,2486,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105119,2451,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(103779,530,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,1534098,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,8001486,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(748,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725683,10010067,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(76139,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,3000387,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10020018,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(305100,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327250,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(16500000,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327261,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,3000384,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,8001545,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,8001546,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(720516,10000353,''CREATININE'',''3097-3'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,8001531,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1620,8000228,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105107,2381,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105123,2383,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105121,2383,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(90544,8001546,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105171,2383,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(88991,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,3000122,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(738,10020000,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98223,3005513,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327250,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(85478,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725866,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(245333,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327246,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(721807,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(16500000,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(78045,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(725882,12418,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327238,12292,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(247602,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(892,10010898,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105297,2477,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105315,2477,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98223,8001546,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(21289,10010150,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(748,8001549,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,8001549,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105109,2450,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105283,2450,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327232,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(720516,10000549,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105123,2451,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(1750,8000232,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98225,3000362,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(89041,8001486,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,8001486,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105119,2383,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(720516,10001991,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(105193,2387,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(89041,8001485,''SODIUM'',''2947-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(748,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(303647,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327261,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(686,3000378,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(85478,10000139,''ALBUMIN'',''1751-7'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(984,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(688,10000322,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(678,8001522,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(16500000,12344,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(682,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(98219,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(83974,10010264,''CREATININE'',''2160-0'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(10274,1511118,''SODIUM'',''2951-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327261,12313,''BILIRUBIN'',''1975-2'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(2126,12378,''INR'',''6301-6'')
INTO XDR_ACP_LAB_DRV(PROC_ID,COMPONENT_ID,LAB_CATEGORY,LOINC_CODE)VALUES(327252,12378,''INR'',''6301-6'')
SELECT 1 FROM DUAL'; 
    commit;   

--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_LAB_DRV';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_LAB_DRV', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
      commit;

--    --Insert records
--    EXECUTE IMMEDIATE  'INSERT ALL  
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(98221, 3000384, ''ALBUMIN'', ''1751-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10000322, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721807, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725866, 12344, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1804, 10010147, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(247602, 12378, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327238, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 10020051, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327246, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303991, 10010147, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35249, 3003777, ''CREATININE'', ''2162-6'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305100, 10001991, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90194, 3001475, ''CREATININE'', ''2162-6'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35361, 10000140, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(84130, 10011123, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64444, 3000578, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725683, 10010159, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305064, 10000323, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90196, 10000552, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725683, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(43991, 10000138, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(892, 10010898, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(16500000, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725765, 10010540, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(76139, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327261, 12540, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327261, 12540, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725898, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725898, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35271, 3000415, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305116, 10000318, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(165000000, 12344, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88991, 10000549, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35203, 10010269, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303729, 10010149, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(165000000, 12378, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35375, 10001992, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303665, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303665, 10010177, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90176, 3001330, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303949, 10010900, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1042, 3000452, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(107496, 10000138, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1750, 3000122, ''INR'', ''6301-6'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35361, 3000571, ''ALBUMIN'', ''13986-5'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(686, 3000378, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(678, 3000378, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(98221, 3000362, ''SODIUM'', ''2947-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64588, 10010639, ''ALBUMIN'', ''1754-1'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90140, 3000547, ''ALBUMIN'', ''14956-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 10000319, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(678, 10020018, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(678, 10000353, ''CREATININE'', ''3097-3'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 10020000, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(738, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327238, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90196, 3001367, ''CREATININE'', ''2161-8'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(103339, 3003927, ''ALBUMIN'', ''1747-5'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 3000512, ''CREATININE'', ''2164-2'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721973, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305100, 10000353, ''CREATININE'', ''3097-3'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725866, 12418, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(752, 10010148, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303989, 10010147, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90148, 3001330, ''CREATININE'', ''2161-8'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64611, 10000550, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35361, 10010801, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305064, 10010149, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(2126, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(98219, 10010264, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35195, 3003777, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1804, 12312, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(748, 10020051, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(10274, 1511118, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(43967, 10001991, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(44947, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(2126, 13269, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35361, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725683, 10010070, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1620, 3003794, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90202, 10010269, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(107576, 10020100, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(2126, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35315, 10010266, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327250, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(60938, 10010264, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64611, 3005214, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 10000551, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(109494, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90152, 3001396, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35199, 3001330, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35297, 3001478, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1620, 1553372, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 12344, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(42237, 10012831, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35197, 3001330, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305064, 10000320, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90172, 3001361, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725695, 10000320, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 3000362, ''SODIUM'', ''2947-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 3000378, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10010264, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64588, 3000546, ''CREATININE'', ''30000-4'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10010898, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35373, 3000472, ''SODIUM'', ''2955-3'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64588, 10010640, ''ALBUMIN'', ''9318-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35375, 3000490, ''SODIUM'', ''21525-1'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10000549, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1750, 10020029, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327246, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35263, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88078, 3004056, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64588, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64588, 10001346, ''ALBUMIN'', ''14957-5'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 3000508, ''CREATININE'', ''20624-3'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(678, 12344, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(98221, 3000387, ''BILIRUBIN'', ''1975-2'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 3000507, ''CREATININE'', ''2162-6'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327238, 12418, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88078, 3001261, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(780, 10010264, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(83974, 10010898, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(83974, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(886, 10000138, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88078, 3004005, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(85478, 10000322, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(84130, 10010266, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305064, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35269, 3001382, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725882, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35197, 3003777, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(16500000, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(85478, 10000139, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327256, 12344, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(210306, 8011409, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725789, 10011277, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303925, 10010801, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(748, 10000322, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(304776, 10000549, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90194, 10010268, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327261, 12344, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(56565, 10010147, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721985, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(41801, 10010070, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(56565, 10000318, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 12418, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(748, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35351, 3001330, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(41801, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(738, 10020000, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35315, 10001346, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 10010265, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303661, 10010159, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303991, 10000318, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(718411, 10001157, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 3005513, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 10010264, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35311, 10000552, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327261, 12418, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327238, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725789, 10011278, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35261, 10010266, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725898, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88991, 10010159, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(22961, 3000476, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(21415, 3000476, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305064, 10010148, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(98223, 3000384, ''ALBUMIN'', ''1751-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 3000389, ''BILIRUBIN'', ''15152-2'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(688, 3000387, ''BILIRUBIN'', ''1975-2'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(686, 3000384, ''ALBUMIN'', ''1751-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10010070, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(682, 10001991, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(678, 10020050, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64716, 3001330, ''CREATININE'', ''2161-8'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(304672, 10000318, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721807, 12378, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721807, 12292, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(305100, 10000549, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721973, 10000322, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327238, 12344, ''CREATININE'', ''2160-0'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(63464, 3004461, ''ALBUMIN'', ''6942-7'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(1752, 3004475, ''INR'', ''6301-6'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(63464, 3000571, ''ALBUMIN'', ''13986-5'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(83974, 10010159, ''CREATININE'', ''3097-3'')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(303671, 10010266, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(721263, 10010269, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725922, 12378, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(76139, 10010067, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(304758, 10010150, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(109390, 10010159, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(90308, 3000434, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(725683, 10010264, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327261, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327252, 12378, ''INR'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35375, 10010899, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(2126, 12418, ''SODIUM'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(102923, 10010269, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(2647, 10010801, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(88078, 3005203, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(878, 10001819, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64575, 10000551, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327250, 12311, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(780, 10020018, ''CREATININE'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35227, 10000140, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(64444, 10010639, ''ALBUMIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(327250, 12313, ''BILIRUBIN'', '''')
--INTO XDR_ACP_LAB_DRV(PROC_ID, COMPONENT_ID, LAB_CATEGORY, LOINC_CODE)VALUES(35249, 10010269, ''CREATININE'', '''') 
--SELECT 1 FROM DUAL'; 
--    commit;   
--- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_LAB_DRV';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_LAB_DRV', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
--      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

  END p_create_lab_drv_tbl;


-- We created a permanent table that includes geocoders and other information
--PROCEDURE p_create_rnd_arm_tbl AS
--   v_procname varchar2(100) := 'p_create_rnd_arm_tbl';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--
--    --- update dash_etl_log with record count prior to truncate 
----    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;
--
--    --Create table 
----    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE "CTSI_RESEARCH"."XDR_ACP_RANDOMIZATION" 
----   (	"CLINIC_ID" NUMBER, 
----	"ARM" NUMBER, 
----	"CLINIC_NAME" VARCHAR2(80 BYTE), 
----	"GO_LIVE_DATE" DATE
----   ) ON COMMIT PRESERVE ROWS ;
----    commit;   
--
--    --Insert records
--    EXECUTE IMMEDIATE  'INSERT ALL 
--                             into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8084,1,''TO UCLA HEALTH SYSTEM THOUSAND OAKS'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1887,2,''EIMG West Side Health Center Ste. 130'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (6000,3,''WW WOMENS HLTH CTR 250'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8150,3,''MU CPN MALIBU STUART RANCH'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7084,2,''SMBP 12TH ST'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1930,3,''EIMG JACK SKIRBALL HEALTH CENTER'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7021,1,''SM SMBP WILSHIRE'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8092,2,''TOR SKYPARK'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8008,1,''MDR SMBP PLAYA MARINA'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1892,3,''EIMG Toluca Lake Health Center'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (4545,2,''MED Beverly Hills Multi-Specialty'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1846,2,''TOR TORRANCE PRIMARY AND SPECIALTY CARE'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8002,1,''LA CPN WEST WASHINGTON'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7007,2,''SM SMBP PLAZA'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (6016,1,''WW MED SPECIALTY SUITES'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7000,3,''SM INTERNAL MEDICINE AND PEDIATRICS'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (6002,3,''WW WOMENS HLTH CTR 290'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7008,2,''SM CPN SM 15TH STREET'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7024,2,''SM EAST WEST MEDICINE'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8000,1,''BW CPN BRENTWOOD'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8182,1,''CC CENTURY CITY'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7059,3,''SM SANTA MONICA 1245 16TH'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1847,3,''PV PALOS VERDES'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8022,1,''PR UCLA HEALTH SYSTEM PORTER RANCH'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (6017,3,''WW INTERNAL MED SUITE'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1891,1,''EIMG Bob Hope Health Center'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8006,3,''MB CPN MANHATTAN BEACH'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (2455,2,''Woodland Hills CPN'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7023,1,''SM CPN SM PARKSIDE'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (6004,3,''WW PRIM CARE STE 490'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8082,1,''WLV WESTLAKE VILL PRIM CARE AND MED SPEC'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8151,1,''SV SIMI VALLEY'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8085,2,''RB UCLA HEALTH SYSTEM BEACH CITIES'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7011,1,''SM FAMILY HEALTH CENTER'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8184,1,''UCLA Health Encino Specialty Care'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (4750,2,''MED BURBANK SPECIALTIES'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7046,2,''SM IM CONSULTANTS OF SM'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1890,2,''EIMG Santa Clarita Health Center Ste. 210'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (1675,3,''SC SANTA CLARITA VALENCIA'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (7025,2,''SM SMBP OCEAN PARK'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
-- into CTSI_RESEARCH.XDR_ACP_RANDOMIZATION (CLINIC_ID,ARM,CLINIC_NAME,GO_LIVE_DATE) values (8010,2,''PP SMBP PACIFIC PALISADES'',to_date(''11/15/2019 00:00'',''mm/dd/yyyy hh24:mi''))
--                        SELECT 1 FROM DUAL';
--    commit;   
----- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_RANDOMIZATION';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RANDOMIZATION', sysdate, v_audit_cnt,v_procname,'Create lookup reference table');
--      commit;
--
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--
--  END p_create_rnd_arm_tbl;

  procedure p_acp_create_denominator(p_cohort_table in varchar2, p_dept_driver_table in varchar2, p_appt_driver_table in varchar2)  as
 q1 varchar2(4000);
    v_procname varchar2(100) := 'p_acp_create_denominator';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --- update dash_etl_log with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from ' || p_observation_dest_tbl;

 q1 := 'INSERT INTO ' || p_cohort_table  || '(PAT_ID,current_age, CREATION_DATE,CUR_PCP_PROV_ID, LANGUAGE_C)  
        SELECT DISTINCT x.pat_id 
                    ,FLOOR(MONTHS_BETWEEN(TRUNC(sysdate),TRUNC(pat.BIRTH_DATE))/12) AS CURRENT_AGE 
            ,SYSDATE AS CREATION_DATE 
            ,pat.CUR_PCP_PROV_ID 
            ,pat.LANGUAGE_C 
        FROM (SELECT enc.pat_id 
                    ,PAT.BIRTH_DATE 
            ,count(enc.pat_enc_csn_id) AS pat_enc_count 
        FROM clarity.pat_enc                        enc 
        LEFT JOIN '|| p_cohort_table  ||  '         coh  ON enc.pat_id = coh.pat_id         
        JOIN clarity.patient                        pat   ON enc.pat_id = pat.pat_id 
        JOIN clarity.clarity_ser                    prov2 ON pat.cur_pcp_prov_id = prov2.PROV_ID   
                                                    AND prov2.user_id IS NOT NULL 
        JOIN ' || p_dept_driver_table || '      dd on enc.department_id = dd.department_id 
        WHERE  
                coh.pat_id is null 
                AND enc.effective_date_dt between sysdate - 366 and sysdate 
                and floor(months_between(TRUNC(sysdate), pat.birth_date)/12) >= 18 
                and enc.enc_type_c in (101
                ,76     --Telemedicine
                ,21076   --Telemedicine
                ) 
                and (enc.appt_status_c is not null and enc.appt_status_c not in (SELECT APPT_STATUS_C 
                                                                                FROM ' || p_appt_driver_table || '
                                                                                WHERE appt_cat = ''exclude'') 
                    )  
                GROUP BY enc.PAT_ID, 
                    PAT.BIRTH_DATE)x 
        JOIN clarity.patient                        pat   ON x.pat_id = pat.pat_id 
        WHERE x.pat_enc_count > 1';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Create cohort table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end p_acp_create_denominator;

-------------------------------------------------
-- update patients age. This is used when checking the age related inclusion critieria
-------------------------------------------------
procedure p_acp_update_age(p_cohort_table in varchar2) as
 q1 varchar2(4000);
 v_procname varchar2(100) := 'p_acp_update_age';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
 USING ( 
SELECT DISTINCT coh.PAT_ID 
,FLOOR(MONTHS_BETWEEN(TRUNC(sysdate),TRUNC(pat.BIRTH_DATE))/12) AS CURRENT_AGE 
            FROM ' || p_cohort_table  || '     coh 
            JOIN patient            pat on coh.pat_id = pat.pat_id 
            WHERE 
                coh.SELECTED IS NULL 
 ) R
 ON(COH.PAT_ID = R.PAT_ID) 
 WHEN MATCHED THEN 
 UPDATE SET  
 coh.CURRENT_AGE = r.CURRENT_AGE
 ,coh.UPDATE_DATE = SYSDATE
' ;

 EXECUTE IMMEDIATE q1;
  commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where SELECTED IS NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Update patients age for those not selected');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_update_age;

-------------------------------------------------
-- Check patient vital status to exclude deceased patients 9do not delete from patient list)
-- It uses a function developed by the CTSI team (i2b2.f_death)
-------------------------------------------------
procedure p_acp_exclude_deceased(p_cohort_table in varchar2) as
 q1 varchar2(4000);
 v_procname varchar2(100) := 'p_acp_exclude_deceased';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
 USING ( 
SELECT DISTINCT coh.PAT_ID 
              ,i2b2.f_death_clarity(coh.pat_id,1,1)  as death_date 
            FROM ' || p_cohort_table  || '     coh 
            WHERE 
                i2b2.f_death_clarity(coh.pat_id,2,1)  = ''Known Deceased'' 
                and coh.DECEASED_YN IS NULL 
 ) R
 ON(COH.PAT_ID = R.PAT_ID) 
 WHEN MATCHED THEN 
 UPDATE SET  
 coh.EXCLUDED = 1
 ,coh.EXCLUSION_DATE = SYSDATE
 ,coh.UPDATE_DATE = SYSDATE
 ,coh.EXCLUSION_REASON = ''patient deceased''
 ,coh.DECEASED_YN = 1
 ,coh.death_date = r.death_date
' ;

 EXECUTE IMMEDIATE q1;
  commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where EXCLUSION_REASON = ''patient deceased''';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Exclude already selected and newly deceased patients');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_exclude_deceased;


-------------------------------------------------
-- Update Death Date 
-------------------------------------------------
procedure p_acp_update_death_date(p_cohort_table in varchar2) as
 q1 varchar2(4000);
 v_procname varchar2(100) := 'p_acp_update_death_date';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
 USING ( 
SELECT DISTINCT coh.PAT_ID 
              ,i2b2.f_death_clarity(coh.pat_id,1,1)  as death_date 
            FROM ' || p_cohort_table  || '     coh 
            WHERE 
                coh.DECEASED_YN = 1
                and (
                    coh.death_date is null
                    or trunc(coh.death_date) = to_date(''01/01/0001'' , ''mm/dd/yyyy'')
                )
 ) R
 ON(COH.PAT_ID = R.PAT_ID) 
 WHEN MATCHED THEN 
 UPDATE SET  
 coh.death_date = r.death_date
' ;

 EXECUTE IMMEDIATE q1;
  commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where death_date is not null';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Update death date');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_update_death_date;

-------------------------------------------------
-- Check patient vital status to exclude restriced patients 
-- This only applies to the research cohort
-- (do not delete from patient list)
-------------------------------------------------
procedure p_acp_flag_restricted(p_cohort_table in varchar2, p_driver_table in varchar2) as
 q1 varchar2(4000);
 v_procname varchar2(100) := 'p_acp_flag_restricted';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
 USING ( 
 SELECT coh.pat_id  
                FROM ' || p_cohort_table ||'                   coh 
                --ccv4: patient_id changes 
                JOIN patient_fyi_flags           flags ON coh.pat_id = flags.patient_id 
                left JOIN ' || p_driver_table || '      st   on flags.PAT_FLAG_TYPE_C = st.PAT_FLAG_TYPE_C 
--                                left JOIN I2B2.LZ_CLARITY_PATIENT PAT ON COH.PAT_ID = PAT.PAT_ID
                WHERE (flags.PAT_FLAG_TYPE_C is null OR st.PAT_FLAG_TYPE_C IS NOT NULL)
                and coh.RESTRICTED_YN IS NULL    --20
                UNION 
                SELECT coh.pat_id 
                FROM ' || p_cohort_table ||'                   coh 
                JOIN patient_3                         ON coh.pat_id = patient_3.pat_id 
--                                left JOIN I2B2.LZ_CLARITY_PATIENT PAT ON COH.PAT_ID = PAT.PAT_ID
                WHERE 
                    (patient_3.pat_id is null 
                    OR patient_3.is_test_pat_yn = ''Y'' 
                    OR patient_3.is_test_pat_yn <> ''N'') 
                and coh.RESTRICTED_YN IS NULL        --0
                UNION
                SELECT coh.pat_id  
                FROM ' || p_cohort_table ||'                   coh
                JOIN patient_2 on coh.pat_id = patient_2.pat_id
                WHERE
                  patient_2.PAT_CONF_NM_REC_ID  is NOT null
                  and coh.RESTRICTED_YN IS NULL        --16
                UNION
                SELECT coh.pat_id  
                FROM ' || p_cohort_table ||'                   coh
                JOIN patient P on coh.pat_id = P.pat_id
                WHERE
                      (p.pat_mrn_id LIKE ''<%>'' 
                      OR  p.pat_mrn_id LIKE ''99%''  
                      OR  p.pat_mrn_id LIKE ''%Z%''
                      OR p.birth_date is  NULL
                      OR  P.PAT_NAME  LIKE ''%dummy%'' 
                      OR  (P.pat_last_name || P.PAT_FIRST_NAME || P.PAT_MIDDLE_NAME) LIKE ''%dummy%''
                      OR P.PAT_NAME  LIKE ''TR-%''  
                      OR  P.PAT_NAME  LIKE ''YY%'' 
                      OR P.PAT_NAME LIKE ''ZZ%''
                      OR p.restricted_yn = ''Y''
                      )and coh.RESTRICTED_YN IS NULL        --0
               UNION
                SELECT coh.pat_id 
                FROM ' || p_cohort_table ||'                   coh
                --ccv4:(10/21/19) 
                JOIN (Select Distinct PAC.PAT_ID,Acct.CONF_NAM_OF_ASSC_PT  From PAT_ACCT_CVG PAC
              Join ACCOUNT Acct on Acct.ACCOUNT_ID = PAC.ACCOUNT_ID
              Where Acct.CONF_NAM_OF_ASSC_PT IS NOT NULL
              ) cnfgtor on COH.pat_id = cnfgtor.pat_id      
                WHERE  coh.RESTRICTED_YN IS NULL    
 ) R
 ON(COH.PAT_ID = R.PAT_ID) 
 WHEN MATCHED THEN 
 UPDATE SET  
 coh.UPDATE_DATE = SYSDATE
  ,coh.RESTRICTED_YN = 1
' ;

 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where RESTRICTED_YN = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
            INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Patients labeled as RESTRICTED');
      commit;    
      EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end p_acp_flag_restricted;

-------------------------------------------------
-- Pull all Problem list dx codes for patient denominator 
-------------------------------------------------
procedure P_ACP_PL_DX_TBL(p_table_name  in varchar2, p_cohort_table in varchar2, p_driver_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_PL_DX_TBL';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_PL_DX(PAT_ID VARCHAR2(18 BYTE),DX_FLAG VARCHAR2(25 BYTE)) ON COMMIT PRESERVE ROWS';
--    COMMIT;
--
--    EXECUTE IMMEDIATE  'create index XDR_ACP_PL_DX_id_patdx_flag on XDR_ACP_PL_DX(pat_id,DX_FLAG)';
--    COMMIT;

  q1 := 'INSERT INTO ' || p_table_name || ' 
                SELECT coh.pat_id, drv.dx_flag 
                FROM ' || p_cohort_table  || '          coh  
                JOIN problem_list                     pl    ON coh.pat_id = pl.pat_id AND pl.rec_archived_yn = ''N'' 
                JOIN zc_problem_status                zps   ON pl.problem_status_c = zps.problem_status_c 
                JOIN ' || p_driver_table ||'   drv   ON pl.dx_id = drv.dx_id 
  where  
        zps.name = ''Active'' 
        AND coh.SELECTED IS NULL';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_PL_DX';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PL_DX', sysdate, v_audit_cnt,v_procname,'Pull problem list records for patients in denominator');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_PL_DX_TBL;


-------------------------------------------------
-- Update PL_DX flags for the different conditions in the criterium
-------------------------------------------------
 procedure P_ACP_PL_DX(p_cohort_table in varchar2, p_table_name in varchar2, p_dx_flag in varchar2) as
 q1 varchar2(4000);
 v_procname varchar2(100) := 'P_ACP_PL_DX';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || 
  ' SET PL_' || p_dx_flag || ' = 1
  ,UPDATE_DATE = SYSDATE 
  WHERE 
    SELECTED IS NULL 
    AND PAT_ID IN ( 
                SELECT DISTINCT pat_id 
                FROM ' || p_table_name  || '          
               WHERE dx_flag = ''' || p_dx_flag || ''' 
               )';
 EXECUTE IMMEDIATE q1;
  commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where PL_' || p_dx_flag || ' = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PL_DX', sysdate, v_audit_cnt,v_procname,p_dx_flag);
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_PL_DX;

-------------------------------------------------
-- Update PL_DX flags for the ESDL specific conditions in the criteriu
-------------------------------------------------
procedure P_ACP_PL_ESDL_DECOMPENSATION(p_cohort_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_PL_ESDL_DECOMPENSATION';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := '
  UPDATE ' || p_cohort_table  || 
  ' SET pl_ESDL_decompensation = 1 
  ,UPDATE_DATE = SYSDATE 
  WHERE  
        SELECTED IS NULL
        AND (PL_PERITONITIS = 1 
        OR PL_ASCITES = 1 
        OR PL_BLEEDING = 1 
        OR PL_ENCEPHALOPATHY = 1 
        OR PL_HEPATORENAL = 1)';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where pl_ESDL_decompensation = 1 ';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PL_DX', sysdate, v_audit_cnt,v_procname,'pl_ESDL_decompensation');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_PL_ESDL_DECOMPENSATION;

-------------------------------------------------
-- Pull all Encounters DX codes for patient denominator 
-------------------------------------------------
procedure P_ACP_ENC_DX_TBL(p_table_name  in varchar2, p_cohort_table in varchar2, p_driver_table in varchar2, p_timeframe in number) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ENC_DX_TBL';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_ENC_DX(PAT_ID VARCHAR2(18 BYTE),DX_FLAG VARCHAR2(25 BYTE)) ON COMMIT PRESERVE ROWS';
--    COMMIT;
--
--    EXECUTE IMMEDIATE  'create index XDR_ACP_ENC_DX_id_patdx_flag on XDR_ACP_ENC_DX(pat_id,DX_FLAG)';
--    COMMIT;

   q1 := 'INSERT INTO ' || p_table_name || ' 
                SELECT coh.pat_id, drv.dx_flag
                FROM ' || p_cohort_table  || '          coh 
                JOIN pat_enc_dx                     dx on coh.pat_id = dx.pat_id 
                JOIN ' || p_driver_table ||'    drv   ON dx.dx_id = drv.dx_id 
                left join pat_enc                   enc on dx.pat_enc_csn_id = enc.pat_enc_csn_id 
                WHERE 
                    coh.SELECTED IS NULL
                    AND dx.CONTACT_DATE between sysdate - (365.25 * ' || p_timeframe || ') and sysdate 
                    AND enc.enc_type_c = 101';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_ENC_DX';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_ENC_DX', sysdate, v_audit_cnt,v_procname,'Pull encounter diagnoses for patients in the denominator');

      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_ENC_DX_TBL;


-------------------------------------------------
-- Update encounter DX flag for the ESDL specific conditions from the criterium
-------------------------------------------------
procedure P_ACP_DX_ESDL_DECOMPENSATION(p_cohort_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_DX_ESDL_DECOMPENSATION';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := '
  UPDATE ' || p_cohort_table  || 
  ' SET DX_ESDL_decompensation = 1 
    ,UPDATE_DATE = SYSDATE 
  WHERE  
        SELECTED IS NULL
        AND (DX_PERITONITIS = 1 
        OR DX_ASCITES = 1 
        OR DX_BLEEDING = 1 
        OR DX_ENCEPHALOPATHY = 1 
        OR DX_HEPATORENAL = 1 
        OR DX_PERITONITIS = 1)';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where dx_ESDL_decompensation = 1 ';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_ENC_DX', sysdate, v_audit_cnt,v_procname,'dx_ESDL_decompensation');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
        end P_ACP_DX_ESDL_DECOMPENSATION;



-------------------------------------------------
-- Update encounter DX flags for the different conditions in the criteriu
-------------------------------------------------
procedure P_ACP_ENC_DX(p_cohort_table in varchar2, p_dx_table in varchar2, p_dx_flag in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ENC_DX';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

begin
   DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
   
 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET DX_' || p_dx_flag || ' = 1 
    ,UPDATE_DATE = SYSDATE 
  WHERE 
    SELECTED IS NULL 
    AND PAT_ID IN ( 
                SELECT DISTINCT dx.pat_id 
                FROM ' || p_dx_table ||'    dx    
                WHERE dx.dx_flag = ''' || p_dx_flag || ''' )';
EXECUTE IMMEDIATE q1;
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
  v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where DX_' || p_dx_flag || ' = 1';
    

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
         INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_ENC_DX', sysdate, v_audit_cnt,v_procname,'Criteria ' || p_dx_flag);
               commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_ENC_DX;

-------------------------------------------------
-- Flag patients where no DX flags were identified
-------------------------------------------------
procedure p_acp_flag_pat_with_dxpl(p_cohort_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'p_acp_flag_pat_with_dxpl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  ||
        ' SET NO_DXPL = 1 
          ,UPDATE_DATE = CURRENT_DATE  
          WHERE 
                PL_ALS IS NULL 
                AND PL_CANCER IS NULL 
                AND PL_CHF IS NULL 
                AND PL_CIRRHOSIS IS NULL 
                AND PL_COPD IS NULL 
                AND PL_COPD_SPO2 IS NULL 
                AND PL_ESLD IS NULL 
                AND PL_ESDL_decompensation IS NULL                
                AND PL_ESRD IS NULL 
                AND DX_ALS IS NULL                
                AND DX_CANCER IS NULL 
                AND DX_CHF IS NULL 
                AND DX_CIRRHOSIS IS NULL 
                AND DX_COPD IS NULL 
                --AND DX_COPD_SPO2 IS NULL
                --AND DX_ESLD IS NULL
                AND DX_ESDL_DECOMPENSATION IS NULL 
                AND DX_ESRD IS NULL ';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT WHERE NO_DXPL IS NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Patients with at leat one dx code (encounter or PL)');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_flag_pat_with_dxpl;


-------------------------------------------------
-- Flag oncology department visits for the Advanced Cancer criteria
-------------------------------------------------
procedure P_ACP_DEPT_VISIT_ONC(p_cohort_table in varchar2, p_dept in varchar2, p_years in number, p_criteria in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_DEPT_VISIT_ONC';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET ' || p_dept || '_VISIT = 1 
    ,UPDATE_DATE = SYSDATE 
  WHERE  
    SELECTED IS NULL 
    AND PAT_ID IN ( 
                SELECT DISTINCT  coh.PAT_ID 
FROM ' || p_cohort_table  || '          coh 
JOIN clarity.PAT_ENC                            enc on coh.pat_id = enc.pat_id 
LEFT JOIN clarity.CLARITY_DEP                   dep ON enc.department_id = dep.department_id 
LEFT JOIN clarity.v_cube_d_provider             prv ON enc.visit_prov_id = prv.provider_id 
WHERE 
    (coh.PL_' || p_criteria || ' = 1 OR coh.DX_' || p_criteria || ' = 1) 
    AND 
            (REGEXP_LIKE(dep.specialty,''' || p_dept || ''',''i'') 
            OR 
            REGEXP_LIKE(prv.primary_specialty,''' || p_dept || ''',''i'') 
            ) 
    and enc.enc_type_c = 101 
    AND enc.EFFECTIVE_DATE_DT between sysdate - (365.25 * '|| p_years ||' ) AND sysdate 
    and coh.SELECTED IS NULL 
    )';
 EXECUTE IMMEDIATE q1;
 commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ' || p_dept || '_VISIT = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ' || p_dept || '_VISIT = 1');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_DEPT_VISIT_ONC;

-------------------------------------------------
-- Flag nephrology department visits for the _________ criteria
-------------------------------------------------
procedure P_ACP_DEPT_VISIT_NEPH(p_cohort_table in varchar2, p_dept in varchar2, p_years in number, p_criteria in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_DEPT_VISIT_NEPH';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET ' || p_dept || '_VISIT = 1  
    ,UPDATE_DATE = SYSDATE 
  WHERE  
    SELECTED IS NULL
    AND PAT_ID IN ( 
                SELECT DISTINCT  coh.PAT_ID 
FROM ' || p_cohort_table  || '          coh 
JOIN clarity.PAT_ENC                            enc on coh.pat_id = enc.pat_id 
LEFT JOIN clarity.CLARITY_DEP                   dep ON enc.department_id = dep.department_id 
LEFT JOIN clarity.v_cube_d_provider             prv ON enc.visit_prov_id = prv.provider_id 
WHERE   
    (coh.PL_' || p_criteria || ' = 1 OR coh.DX_' || p_criteria || ' = 1) 
    AND 
            (REGEXP_LIKE(dep.specialty,''' || p_dept || ''',''i'') 
            OR 
            REGEXP_LIKE(prv.primary_specialty,''' || p_dept || ''',''i'') 
            ) 
    AND enc.EFFECTIVE_DATE_DT between sysdate - (365.25 * '|| p_years ||' ) AND sysdate 
    and coh.SELECTED IS NULL 
    )';
 EXECUTE IMMEDIATE q1;
  commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ' || p_dept || '_VISIT = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
          INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ' || p_dept || '_VISIT = 1');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_DEPT_VISIT_NEPH;

-------------------------------------------------
-- Flag nephrology department visits for the _________ criteria
-------------------------------------------------
procedure P_ACP_DEPT_ADMIT(p_cohort_table in varchar2, p_driver_table in varchar2, p_years in number, p_criteria in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_DEPT_ADMIT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET ' || p_criteria || '_ADMIT = 1 
    ,UPDATE_DATE = SYSDATE 
  WHERE 
    SELECTED IS NULL
    AND PAT_ID IN ( 
                SELECT DISTINCT  coh.PAT_ID 
                FROM ' || p_cohort_table  || '          coh 
                JOIN pat_enc_hsp                     enc ON coh.pat_id = enc.pat_id 
                --ccv4:(10/21/19) 
                JOIN pat_enc_dx                      dx ON enc.pat_enc_csn_id = dx.pat_enc_csn_id 
                join ' || p_driver_table ||'  drv on dx.dx_id = drv.dx_id AND drv.DX_FLAG = ''' || p_criteria || ''' 
                WHERE   
                    (coh.PL_' || p_criteria || ' = 1 OR COH.DX_' || p_criteria || ' = 1) 
                    AND dx.contact_date between sysdate - (365.25 * '|| p_years ||' ) AND sysdate
                    and coh.SELECTED IS NULL 
                    )';
 EXECUTE IMMEDIATE q1;
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ' || p_criteria || '_ADMIT = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ' || p_criteria || '_ADMIT = 1');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_DEPT_ADMIT;

-------------------------------------------------
-- Flag chemotherapy procedures for the Advanced Cancer criteria
-------------------------------------------------
procedure P_ACP_CHEMO_PROC(p_cohort_table in varchar2, p_driver_table  in varchar2, p_timeframe in number) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_CHEMO_PROC';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET CHEMO = 1  
    ,UPDATE_DATE = SYSDATE 
  WHERE  
    SELECTED IS NULL
    AND PAT_ID IN (      
        SELECT coh.pat_id 
          FROM ' || p_cohort_table  || '           coh 
          JOIN pat_enc                  enc on coh.pat_id = enc.pat_id 
          JOIN arpb_transactions                  cpt  ON enc.pat_enc_csn_id = cpt.pat_enc_csn_id  
          join ' || p_driver_table  || '                  drv on cpt.cpt_code = drv.cpt_code 
        WHERE 
            (coh.PL_CANCER = 1 OR COH.DX_CANCER = 1) 
            AND TRUNC(enc.EFFECTIVE_DATE_DT ) BETWEEN sysdate - (365.25 * ' || p_timeframe || ') AND sysdate 
        UNION 
        SELECT coh.pat_id 
          FROM ' || p_cohort_table  || '          coh 
          join hsp_account                     acc on coh.pat_id = acc.pat_id  
          JOIN HSP_TRANSACTIONS                  tx  ON acc.HSP_ACCOUNT_ID = tx.HSP_ACCOUNT_ID  
          JOIN pat_enc                          enc on tx.pat_enc_csn_id = enc.pat_enc_csn_id 
          join ' || p_driver_table  || '                  drv on tx.cpt_code = drv.cpt_code 
        WHERE 
            coh.SELECTED IS NULL 
            and (coh.PL_CANCER = 1 OR COH.DX_CANCER = 1) 
            AND TRUNC(enc.EFFECTIVE_DATE_DT ) BETWEEN sysdate - (365.25 * ' || p_timeframe || ') AND sysdate)';


EXECUTE IMMEDIATE q1; 
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CHEMO = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria CHEMO medications');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
        end P_ACP_CHEMO_PROC;

-------------------------------------------------
-- Flag chemotherapy medication treatments for the Advanced Cancer criteria
-------------------------------------------------
procedure P_ACP_CHEMO_MEDS(p_cohort_table in varchar2, p_med_keyword  in varchar2, p_timeframe in number) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_CHEMO_MEDS';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET CHEMO = 1  
    ,UPDATE_DATE = SYSDATE 
  WHERE  
    SELECTED IS NULL
    AND PAT_ID IN (      
        SELECT DISTINCT  med1.pat_id 
        FROM ( 
        SELECT  m.pat_id, 
            m.order_med_id,  
          case when m.medication_id != 800001 then m.medication_id 
               else coalesce(omi.dispensable_med_id, m.user_sel_med_id) end as used_med_id,        
            zom.name as ordering_mode, 
            zoc.name as order_class 
        FROM ' || p_cohort_table  || '      coh 
        JOIN order_med                      m   ON coh.pat_id = m.pat_id 
        LEFT JOIN order_medinfo omi on m.order_med_id = omi.order_med_id 
        left join zc_order_class zoc on m.order_class_C = zoc.order_class_c 
        left join zc_ordering_mode zom on m.ordering_mode_c = zom.ordering_mode_c 
        WHERE  
            coh.SELECTED IS NULL 
            AND (coh.PL_CANCER = 1 OR COH.DX_CANCER = 1) 
            AND TRUNC(m.ordering_date) BETWEEN sysdate - (365.25 * ' || p_timeframe ||') AND sysdate 
            and zoc.name <> ''Historical Med'' 
    ) med1 
LEFT JOIN clarity_medication cm on med1.used_med_id = cm.medication_id 
LEFT JOIN mar_admin_info  mar   ON med1.order_med_id = mar.order_med_id 
--ccv4: mar_action_c changes data type number/varchar2(10/21/19) 
LEFT JOIN zc_mar_rslt     xmrs  ON mar.mar_action_c = xmrs.result_c 
WHERE 
  (
  (med1.ordering_mode = ''Inpatient''                                       
            AND nvl(mar.taken_time,to_date(''01/01/0001'')) <> ''01/01/0001''       -- taken_time was valid
            AND nvl(mar.sig,-1) > 0                                             -- and SIG was valid and > 0
--ccv4: mar_action_c changes data type number/varchar2(10/21/19) 
            AND nvl(mar.mar_action_c,-1) <> ''125''                                 -- and action was anything other than ''Not Given''
         ) 
         OR med1.ordering_mode != ''Inpatient'' 
        )
    AND med1.used_med_id IS NOT NULL 
    AND (
        cm.pharm_subclass_c in (2150)  
        or regexp_like(cm.name,''' || p_med_keyword || ''',''i'') 
        or regexp_like(cm.generic_name,''' || p_med_keyword || ''',''i'') 
    )
    )';

EXECUTE IMMEDIATE q1; 
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CHEMO = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria CHEMO CPT');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_CHEMO_MEDS;

-------------------------------------------------
-- Pull labs to calculate the Meld score for the ESDL criteria
-------------------------------------------------
procedure P_ACP_LAB_PULL(p_table_name in varchar2, p_cohort_table in varchar2, p_driver_table  in varchar2, p_timeframe in number) as
 q1 varchar2(6000);
 q2 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_LAB_PULL';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
    --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_LAB(
--    PAT_ID VARCHAR2(18 BYTE), 
--	PAT_ENC_CSN_ID NUMBER(18,0), 
--	PROC_CODE VARCHAR2(91 BYTE), 
--	COMPONENT_ID NUMBER(18,0), 
--	RESULT_TIME DATE, 
--	LAB_FLAG VARCHAR2(50 BYTE),
--	HARM_NUM_VAL NUMBER
--    ) 
-- ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   

 q1 := 'INSERT INTO ' || p_table_name || '(PAT_ID,PAT_ENC_CSN_ID,PROC_CODE,COMPONENT_ID, RESULT_TIME, LAB_FLAG, HARM_NUM_VAL) 
     SELECT 	DISTINCT coh.pat_id, 
                o.pat_enc_csn_id, 
                --ccv4: mar_action_c changes data type number/varchar2(10/21/19)  
                --p.clarity_EAP__proc_code, 
                p.proc_code,
                o.component_id, 
                p.result_time, 
                drv.LAB_CATEGORY as LAB_FLAG, 
                CASE WHEN REGEXP_LIKE(o.ord_value,'':'',''i'') or REGEXP_SUBSTR(o.ord_value,''[1-9]\d*(\.\,\d+)?'') IS NULL 
                       THEN o.ord_num_value 
                  WHEN REGEXP_LIKE(o.ord_value,''[<>]=*'',''i'') 
                       THEN TO_NUMBER(REGEXP_SUBSTR(o.ord_value,''-?[[:digit:],.]*$''),''9999999999D9999999999'', ''NLS_NUMERIC_CHARACTERS = ''''.,'''''' ) 
                  WHEN REGEXP_LIKE(o.ord_value,''%'',''i'')  
                       THEN TO_NUMBER(REGEXP_SUBSTR(o.ord_value,''[1-9]\d*(\.\,\d+)?''),''9999999999D9999999999'', ''NLS_NUMERIC_CHARACTERS = ''''.,'''''' )   
                  ELSE o.ord_num_value END as harm_num_val                       
      FROM order_results                o 
      --ccv4: proc_code becomes clarity_EAP__proc_code(10/21/19) 
      JOIN order_proc                   p   ON p.order_proc_id = o.order_proc_id 
      JOIN ' || p_cohort_table  || '    coh ON p.pat_id = coh.pat_id AND (coh.PL_CIRRHOSIS = 1 OR COH.DX_CIRRHOSIS = 1) AND coh.SELECTED IS NULL 
      JOIN ' || p_driver_table  || '    drv ON p.proc_id = drv.proc_id and o.component_id = drv.component_id 
      JOIN order_proc_2                 op2 ON p.ORDER_PROC_ID = op2.ORDER_PROC_ID  
      JOIN clarity_component            cc  ON o.component_id = cc.component_id 
      LEFT JOIN lnc_db_main             ldm ON cc.DEFAULT_LNC_ID = ldm.record_id  
      WHERE    
              coh.SELECTED IS NULL   
              AND p.order_type_c IN (7) 
              AND o.ord_value IS NOT NULL 
              AND o.order_proc_id IS NOT NULL 
              AND p.order_time BETWEEN SYSDATE - (365.25 * ' || p_timeframe || ') AND CURRENT_DATE';

q2 := 'CREATE INDEX ' || p_table_name || '_IX_RSLT_FLAG ON ' || p_table_name || '(result_time,LAB_FLAG)';

EXECUTE IMMEDIATE q1;
--EXECUTE IMMEDIATE q2;

   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_table_name;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values (p_table_name, sysdate, v_audit_cnt,v_procname,'Pull lab records for cohort population');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_LAB_PULL;

-------------------------------------------------
-- Process labs results to calculate the Meld score for the ESDL criteria
-------------------------------------------------
procedure P_ACP_LAB_MELD_TABLE( p_lab_table in varchar2, p_meld_table in varchar2) as
 q1 varchar2(8000);
  v_procname varchar2(100) := 'P_ACP_LAB_MELD_TABLE';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

    --Create table (TABLE IS BEING TRUNCATED INSTEAD)
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_MELD_TABLE ("PAT_ID" VARCHAR2(18 BYTE)
--       ,"BILIRUBIN" NUMBER
--       ,"BILIRUBIN_RESULT_TIME" DATE
--       ,"CREATININE" NUMBER
--       ,"CREATININE_RESULT_TIME" DATE
--       ,"INR" NUMBER
--       ,"INR_RESULT_TIME" DATE
--       ,"LATEST_LAB" DATE
--       ,"SODIUM" NUMBER
--       ,"SODIUM_RESULT_TIME" DATE
--   )  
-- ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   


q1 :=  'INSERT INTO ' || p_meld_table  || ' (PAT_ID,BILIRUBIN,BILIRUBIN_RESULT_TIME,CREATININE,CREATININE_RESULT_TIME,INR,INR_RESULT_TIME,LATEST_LAB,SODIUM,SODIUM_RESULT_TIME)
select pat_id
        ,BILIRUBIN
        ,BILIRUBIN_RESULT_TIME
        ,CREATININE
        ,CREATININE_RESULT_TIME
        ,INR
        ,INR_RESULT_TIME
        ,LATEST_LAB
        ,SODIUM
        ,SODIUM_RESULT_TIME
from (
        select pat_id
                ,BILIRUBIN
                ,BILIRUBIN_RESULT_TIME
                ,CREATININE
                ,CREATININE_RESULT_TIME
                ,MIN(ABS(LATEST_LAB - CREATININE_RESULT_TIME)) OVER (partition by pat_id) as last_creatinine
                ,ABS(LATEST_LAB - CREATININE_RESULT_TIME) as DIFF_CREATININE
                ,INR
                ,INR_RESULT_TIME
                ,MIN(ABS(LATEST_LAB - INR_RESULT_TIME)) OVER (partition by pat_id) as last_inr
                ,ABS(LATEST_LAB - INR_RESULT_TIME) as DIFF_INR
                ,LATEST_LAB
                ,SODIUM
                ,SODIUM_RESULT_TIME
                ,MIN(ABS(LATEST_LAB - SODIUM_RESULT_TIME)) OVER (partition by pat_id) as last_sodium
                ,ABS(LATEST_LAB - SODIUM_RESULT_TIME) as DIFF_SODIUM
        from (select * from (
            select DISTINCT x.PAT_ID
                                ,x.BILIRUBIN
                                ,x.BILIRUBIN_result_time
                                ,x.INR
                                ,x.INR_result_time
                                ,x.diff_INR
                                ,x.CREATININE
                                ,x.CREATININE_result_time
                                ,x.diff_creatinine
                                ,x.SODIUM
                                ,x.SODIUM_result_time
                                ,x.diff_SODIUM
                                ,MAX(x.BILIRUBIN_result_time) OVER (PARTITION BY x.PAT_ID) AS LATEST_LAB
             from (
                     SELECT DISTINCT bili.PAT_ID
                                        ,bili.result_time as BILIRUBIN_result_time
                                        ,bili.harm_num_val as BILIRUBIN
                                        ,inr.INR
                                        ,inr.INR_result_time
                                        ,ABS(bili.result_time - inr.INR_result_time) as diff_INR
                                        ,cr.CREATININE
                                        ,cr.CREATININE_result_time
                                        ,ABS(bili.result_time - cr.CREATININE_result_time) as diff_creatinine
                                        ,sod.SODIUM
                                        ,sod.SODIUM_result_time
                                        ,ABS(bili.result_time - sod.SODIUM_result_time) as diff_sodium
                                    FROM ' || p_lab_table || ' bili
                                    JOIN (SELECT DISTINCT lab.PAT_ID
                                                ,lab.result_time as INR_result_time
                                                ,lab.harm_num_val as INR
                                            FROM ' || p_lab_table || ' lab
                                            WHERE LAB.LAB_FLAG = ''INR'' AND lab.harm_num_val <> 9999999) inr on bili.pat_id = inr.pat_id and (bili.result_time - inr.INR_result_time) between -1 and 1
                                    JOIN (SELECT DISTINCT lab.PAT_ID
                                                ,lab.result_time as CREATININE_result_time
                                                ,lab.harm_num_val as CREATININE
                                            FROM ' || p_lab_table || ' lab
                                            WHERE LAB.LAB_FLAG = ''CREATININE'' AND lab.harm_num_val <> 9999999) cr on bili.pat_id = cr.pat_id and (bili.result_time - cr.CREATININE_result_time) between -1 and 1                        
                                    JOIN (SELECT DISTINCT lab.PAT_ID
                                                ,lab.result_time as SODIUM_result_time
                                                ,lab.harm_num_val as SODIUM
                                            FROM ' || p_lab_table || ' lab
                                            WHERE LAB.LAB_FLAG = ''SODIUM'' AND lab.harm_num_val <> 9999999) sod on bili.pat_id = sod.pat_id and (bili.result_time - sod.SODIUM_result_time) between -1 and 1                        
                                    WHERE bili.LAB_FLAG = ''BILIRUBIN'' AND bili.harm_num_val <> 9999999                
                            ) x
                            )
                            where LATEST_LAB = BILIRUBIN_result_time
                            )
        )x
where 
diff_inr = last_inr
and diff_sodium = last_sodium
and diff_creatinine = last_creatinine';
EXECUTE IMMEDIATE q1; 
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_meld_table;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
          INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values (p_meld_table, sysdate, v_audit_cnt,v_procname,'Pull meld related records from lab records');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_LAB_MELD_TABLE;


-------------------------------------------------
-- Update MELD flagas part of the ESDL criteria
-------------------------------------------------
procedure P_ACP_MELD(p_cohort_table in varchar2, p_lab_table in varchar2) as
 q1 varchar2(6000);
  v_procname varchar2(100) := 'P_ACP_MELD';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || 
  ' SET MELD = 1 
    ,UPDATE_DATE = SYSDATE 
  WHERE  
     SELECTED IS NULL 
     AND PAT_ID IN ( 
                    select DISTINCT pat_id 
                    from ( 
                            select pat_id 
                                    ,round( 
                                    ( 
                                        (0.378 * ln(Bilirubin)) + (1.120 * ln(INR)) + ((0.957 * ln(Creatinine)) + 0.643) 
                                    ) * 10 
                                    ,1) as meld 
                                ,sodium 
                                ,Bilirubin 
                                ,creatinine 
                                ,inr 
                    from( 
                        select  
                                labs.pat_id 
                                ,labs.Bilirubin 
                                ,labs.INR 
                                ,case when labs.Creatinine > 4.0 or dia.pat_id is not null then 4.0 
                                    else labs.Creatinine 
                                    end Creatinine                 
                                ,case when labs.sodium > 137 then 137 
                                    when labs.sodium < 125 then 125 
                                    else labs.sodium 
                                    end sodium 
                        from '  || p_cohort_table  || '     coh 
                        JOIN  ' || p_lab_table || '                   LABS ON COH.PAT_ID = LABS.PAT_ID 
                        left join (select pat_id, CREATININE_result_time 
                                    from ( 
                                        select lab.pat_id 
                                                ,lab.CREATININE_result_time 
                                                ,count(dia.contact_date) dialysis_count 
                                        from  ' || p_lab_table || '   lab 
                                        join  (SELECT DIAL.* 
                                                FROM PT_DIALYSIS_HX                 dial 
                                                JOIN  '|| p_cohort_table  ||'     coh ON dial.pat_id = coh.pat_id  
                                                                                    AND (coh.PL_CIRRHOSIS = 1 OR COH.DX_CIRRHOSIS = 1) 
                                                )          dia  on lab.pat_id = dia.pat_id  
                                                                and dia.CONTACT_DATE between lab.CREATININE_result_time - 7  and lab.CREATININE_result_time   
                                        group by lab.pat_id,lab.CREATININE_result_time 
                                        ) 
                        where dialysis_count >= 2)        dia on labs.pat_id = dia.pat_id and labs.CREATININE_RESULT_TIME = dia.CREATININE_RESULT_TIME 
                        ) 
            ) 
where meld + 1.32 * (137 - sodium) - (0.033 * meld * (137 - sodium)) > 18) ';
 EXECUTE IMMEDIATE q1;
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where MELD = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria MELD = 1');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_MELD;

-------------------------------------------------
-- Extract Ejection Fraction(EF) scores as part of the hypertension criteria
-------------------------------------------------
procedure P_ACP_EF_NARR(p_table_name in varchar2, p_cohort_table in varchar2, p_timeframe in number) as
 q1 varchar2(6000);
  v_procname varchar2(100) := 'P_ACP_EF_NARR';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 --Create table 
--    EXECUTE IMMEDIATE  'CREATE GLOBAL TEMPORARY TABLE XDR_ACP_NARR (	"PAT_ID" VARCHAR2(18 BYTE), 
--	"ACC_NUM" VARCHAR2(254 BYTE), 
--	"ORDER_PROC_ID" NUMBER(18,0) NOT NULL ENABLE, 
--	"NARR_LINE" NUMBER(38,0) NOT NULL ENABLE, 
--	"NARR_NARRATIVE" VARCHAR2(4000 BYTE), 
--	"ORDER_TIME" DATE, 
--	"ORD_VALUE" VARCHAR2(254 BYTE)
--   ) ON COMMIT PRESERVE ROWS'
--    ;
--    commit;   



 q1 := 'INSERT INTO ' || p_table_name || '(PAT_ID,ACC_NUM,ORDER_PROC_ID,NARR_LINE, NARR_NARRATIVE, ORDER_TIME, ORD_VALUE) 
   SELECT DISTINCT opr.pat_id 
               ,opr.acc_num 
               ,opr.order_proc_id 
               ,nar.line           AS narr_line 
               ,nar.narrative      AS narr_narrative 
		   ,order_time 
		   ,ord_value 
  FROM (SELECT DISTINCT coh.pat_id 
               ,opr.order_proc_id 
               ,opr.order_time 
                ,acc.acc_num 
               ,res.line 
               ,res.ord_value 
  FROM ' || p_cohort_table || '                    coh 
  JOIN order_proc               		opr ON coh.pat_id = opr.pat_id 
  LEFT JOIN order_results       res ON opr.order_proc_id = res.order_proc_id 
  LEFT JOIN order_rad_acc_num   acc ON opr.order_proc_id = acc.order_proc_id 
  WHERE  
  		(coh.pl_chf = 1 or coh.dx_chf = 1) 
        AND coh.SELECTED IS NULL 
        AND opr.order_status_c = 5                     				
        AND OPR.ORDER_TYPE_C = 29 
		AND opr.result_time between SYSDATE - (365.25 * ' || p_timeframe || ') AND SYSDATE)                      opr 
  JOIN order_narrative  nar ON opr.order_proc_id = nar.order_proc_id 
  WHERE trim(nar.narrative) IS NOT NULL';

EXECUTE IMMEDIATE q1;
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_table_name;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values (p_table_name, sysdate, v_audit_cnt,v_procname,'Pull narratives from orders');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_EF_NARR;

-------------------------------------------------
-- Update EF flag as part of the hypertension criteria
-------------------------------------------------
procedure P_ACP_EF_FLAG(p_cohort_table in varchar2, p_narr_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_EF_FLAG';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET EF = 1  
    ,UPDATE_DATE = SYSDATE 
  WHERE  
    SELECTED IS NULL
    AND PAT_ID IN ( 
    SELECT distinct PAT_ID 
 from ( 
 SELECT PAT_ID 
		        ,ORDER_PROC_ID 
		        ,ORDER_TIME 
		        ,CASE 
				WHEN 
					ORD_VALUE IS NULL 
				THEN TEST_VALUES 
				ELSE (CASE 
						WHEN	REGEXP_LIKE ( ORD_VALUE	,''\+.\-'',''i'' ) 
						THEN TO_CHAR(TO_NUMBER(REGEXP_SUBSTR(ORD_VALUE,''[1-9]\d*(\.\,\d+)?''),''9999999999D9999999999'',''NLS_NUMERIC_CHARACTERS = ''''.,'''''') - 5) 
						ELSE COALESCE(REGEXP_SUBSTR(ORD_VALUE,''[1-9]\d*(\.\,\d+)?''),REGEXP_SUBSTR(ORD_VALUE,''?[[:digit:],.]*$'') ) 
					END)END AS LVEF_FINAL_VALUE 
		        ,TEST_VALUES NARR_VALUE 
		        ,ORD_VALUE 
		        ,NARR_AGG 
		    FROM  ( 
			SELECT PAT_ID 
			      ,ORDER_PROC_ID 
			      ,ORDER_TIME 
			      ,ORD_VALUE 
			      ,TRIM(	CASE 
					WHEN 
						REGEXP_LIKE(SUBSTR(NARR_AGG,REGEXP_INSTR(LOWER(NARR_AGG),''\d++.(to|-).\d++.(|^%)'',5),8),''(to|-)'',''i'') 
					THEN SUBSTR(NARR_AGG,REGEXP_INSTR(LOWER(NARR_AGG),''\d++.(to|-).\d++.(|^%)'',5),2) 
					ELSE SUBSTR(NARR_AGG,REGEXP_INSTR(LOWER(NARR_AGG),''\d++.(|^%)'',5),2) 
				END) AS TEST_VALUES 
			      ,NARR_AGG 
			  FROM (SELECT LVEF.PAT_ID 
		      ,LVEF.ORDER_PROC_ID 
		      ,LVEF.ACC_NUM 
		      ,LVEF.ORDER_TIME 
		      ,LVEF.ORD_VALUE 
		      ,LISTAGG(NARR.NARR_LINE 
		                  || ''|'' 
		                  || NARR.NARR_NARRATIVE,'' || '') WITHIN  GROUP(			 ORDER BY NARR.NARR_LINE		) NARR_AGG 
		  FROM (SELECT PAT_ID 
		      ,ACC_NUM 
		      ,ORDER_PROC_ID 
		      ,NARR_LINE 
		      ,ORDER_TIME 
		      ,ORD_VALUE 
		      ,NARR_NARRATIVE 
		  FROM ' || p_narr_table || '
		 WHERE (			LOWER(NARR_NARRATIVE) LIKE ''%ejection%'' 
			    OR UPPER(NARR_NARRATIVE) LIKE ''%LVEF%'' 
			    OR LOWER(NARR_NARRATIVE) LIKE ''%fraction%'')) LVEF 
          JOIN ' || p_narr_table || ' NARR ON LVEF.ORDER_PROC_ID = NARR.ORDER_PROC_ID  
		  							AND NARR.NARR_LINE  BETWEEN LVEF.NARR_LINE and LVEF.NARR_LINE  + 1 
		 GROUP BY LVEF.PAT_ID 
		      ,LVEF.ORDER_PROC_ID 
		      ,LVEF.ACC_NUM 
		      ,LVEF.ORDER_TIME 
		      ,LVEF.ORD_VALUE) 
		)) 
            WHERE LVEF_FINAL_VALUE in (''1'',''2'',''3'',''4'',''5'',''6'',''7'',''8'',''9'',''10'',''11'',''12'',''13'',''14'',''15'',''16'',''17'',''18'',''19'',''20'',''21'',''22'',''23'',''24'',''25'',''26'',''27'',''28'',''29'',''30'',''31''))';  

EXECUTE IMMEDIATE q1; 
 commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where EF = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria EF = 1');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

        end P_ACP_EF_FLAG;

-------------------------------------------------
-- Merge all flags to update the different condition flags
-------------------------------------------------
procedure P_ACP_MERGE_CRITERION(p_cohort_table in varchar2) as
 q1 varchar2(4000);
 q2 varchar2(4000);
 q3 varchar2(4000);
 q4 varchar2(4000);
 q5 varchar2(4000);
 q6 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_MERGE_CRITERION';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 

 q1 := 'UPDATE ' || p_cohort_table  || ' 
  SET ALS = 1  ,SELECTED = 1  ,UPDATE_DATE = SYSDATE  
  WHERE  
    (PL_ALS = 1 AND DX_ALS = 1)  
        AND SELECTED IS NULL';

 q2 := 'UPDATE ' || p_cohort_table  || ' 
  SET CANCER = 1  ,SELECTED = 1   ,UPDATE_DATE = SYSDATE 
  WHERE  
    (
    (PL_CANCER = 1 AND ONC_VISIT = 1)
    OR
    (DX_CANCER = 1 AND CHEMO = 1)
    )
        AND SELECTED IS NULL'
    ;

q3 := 'UPDATE ' || p_cohort_table  || ' 
  SET CHF = 1 ,SELECTED = 1   ,UPDATE_DATE = SYSDATE 
  WHERE  
        (
        ((PL_CHF = 1 OR DX_CHF = 1) AND EF = 1)
        OR
        (PL_CHF = 1  AND CHF_ADMIT = 1) 
        )
        AND SELECTED IS NULL'
    ;

q4 := 'UPDATE ' || p_cohort_table  || ' 
  SET COPD = 1  ,SELECTED = 1   ,UPDATE_DATE = SYSDATE 
  WHERE  
        (PL_COPD = 1 AND COPD_ADMIT = 1) 
        AND SELECTED IS NULL'
    ;

q5 := 'UPDATE ' || p_cohort_table  || ' 
  SET ESLD = 1 ,SELECTED = 1    ,UPDATE_DATE = SYSDATE 
  WHERE  
        PL_CIRRHOSIS = 1 
        AND 
        (PL_ESDL_DECOMPENSATION = 1
        OR dx_ESDL_decompensation = 1
        OR MELD = 1) 
        AND SELECTED IS NULL'
    ;

q6 := 'UPDATE ' || p_cohort_table  || ' 
  SET ESRD = 1 ,SELECTED = 1   ,UPDATE_DATE = SYSDATE 
  WHERE  
        (
            (PL_ESRD = 1 OR DX_ESRD = 1 )
        AND NEPH_VISIT = 1
        )
        OR
        (PL_ESRD = 1 AND DX_ESRD = 1 ) 
        AND SELECTED IS NULL'
    ;
EXECUTE IMMEDIATE q1; 
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ALS = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ALS = 1');
      commit;   
EXECUTE IMMEDIATE q2; 
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CANCER = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria CANCER = 1');
      commit;   
EXECUTE IMMEDIATE q3; 
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where COPD = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria COPD = 1');
      commit;
EXECUTE IMMEDIATE q4; 
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CHF = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria CHF = 1');

      commit;   

EXECUTE IMMEDIATE q5; 
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ESLD = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ESLD = 1');
      commit; 

EXECUTE IMMEDIATE q6; 
   commit;
--- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ESRD = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria ESRD = 1');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end P_ACP_MERGE_CRITERION;

-------------------------------------------------
-- calculate age criteria 
-- Patients over the age limit (> 75) + one PL DX code
-- This age limit was set up on 2019
-------------------------------------------------
procedure P_ACP_AGE_CRTIERIA(p_cohort_table in varchar2, p_age_limit in varchar2) as
 q1 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_AGE_CRTIERIA';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'UPDATE ' || p_cohort_table  || ' 
        SET AGE = 1, selected = 1  ,UPDATE_DATE = SYSDATE 
        WHERE 
            SELECTED IS NULL
            AND (pl_copd IS NOT NULL
            OR pl_chf IS NOT NULL 
            OR PL_ESRD IS NOT NULL
            OR PL_ALS IS NOT NULL 
            OR PL_CANCER IS NOT NULL
            OR PL_CIRRHOSIS IS NOT NULL)
            and CURRENT_AGE >= ' || p_age_limit || '';
EXECUTE IMMEDIATE q1;
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where AGE = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria AGE = 1');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_AGE_CRTIERIA; 

--procedure p_acp_remove_not_selected(p_cohort_table in varchar2) as
-- q1 varchar2(4000);
--
--  v_procname varchar2(100) := 'p_acp_remove_not_selected';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--
-- q1 := 'DELETE FROM ' || p_cohort_table  ||
--        ' WHERE 
--            SELECTED IS NULL
--';
-- EXECUTE IMMEDIATE q1;
--    commit;
--      --- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Final selection');
--      commit;
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--
--
--end p_acp_remove_not_selected;

-------------------------------------------------
-- Pull all Advacne Directive documents on record for selected patients
-------------------------------------------------
procedure P_ACP_ADPOLST(p_adpolst_table in varchar2, p_cohort_table in varchar2, p_driver_adpolst in varchar2, p_driver_record_stat in varchar2, p_driver_doc_stat in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ADPOLST';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
 q1 :=  'INSERT INTO ' || p_adpolst_table || 
  ' SELECT distinct coh.pat_id 
                                ,bb.doc_info_id 
                                ,bb.SCAN_FILE 
                                ,BT.DOC_GROUP
                                ,bb.doc_recv_time
                                ,case when bb.doc_recv_time between sysdate - (365.25 *3 ) AND sysdate then 1 else 0 end three_year_ad_polst 
                        FROM ' || p_cohort_table ||'          COH   
                        --ccv4:(10/21/19) 
                        join DOC_INFORMATION                    BB on coh.PAT_ID = BB.DOC_PT_ID 
                        join ' || p_driver_adpolst || '        BT on BB.DOC_INFO_TYPE_C = BT.DOC_INFO_TYPE_C 
                        WHERE  
                            --TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 3   AND 
                            BB.IS_SCANNED_YN = ''Y''  
                            -- We noticed that in the case of AD-POLST documents, there were instances where the docs had been deleted 
                            and ( 
                                bb.RECORD_STATE_C IS NULL 
                                OR bb.RECORD_STATE_C not in (SELECT RECORD_STATE_C FROM ' || p_driver_record_stat || ') 
                                )-- Deleted 
                            and ( 
                                bb.DOC_STAT_C IS NULL 
                                OR bb.DOC_STAT_C NOT IN (SELECT DOC_STAT_C FROM ' || p_driver_doc_stat || ') 
                                )-- Error 
                            and bb.DOC_REVOK_DT is null';

EXECUTE IMMEDIATE q1;
    commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_ADPOLST';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_ADPOLST', sysdate, v_audit_cnt,v_procname,'AD POLST TABLE CREATED');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end P_ACP_ADPOLST;

-------------------------------------------------
-- Update AD/POLST Yes/No flag
-------------------------------------------------
procedure P_ACP_ADPOLST_update(p_cohort_table in varchar2, p_adpolst_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ADPOLST_UPDATE';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
 q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
 USING ( 
SELECT DISTINCT PAT_ID 
            ,CASE WHEN POLST_ALL = 0 OR POLST_ALL IS NULL THEN 0 ELSE 1 END POLST_ALL 
            ,CASE WHEN AD_ALL = 0 OR AD_ALL IS NULL THEN 0 ELSE 1 END AD_ALL 
            ,CASE WHEN POLST_THREE = 0 OR POLST_THREE IS NULL THEN 0 ELSE 1 END POLST_THREE 
            ,CASE WHEN AD_THREE = 0 OR AD_THREE IS NULL THEN 0 ELSE 1 END AD_THREE 
FROM ( 
        SELECT PAT_ID 
                ,SUM(POLST_ALL) AS POLST_ALL 
                ,SUM(AD_ALL) AS AD_ALL 
                ,SUM(POLST_THREE) AS POLST_THREE 
                ,SUM(AD_THREE) AS AD_THREE 
        FROM ( 
                SELECT DISTINCT PAT_ID 
                        ,CASE WHEN DOC_GROUP = ''POLST'' THEN 1 ELSE 0 END POLST_ALL 
                        ,CASE WHEN DOC_GROUP  = ''AD'' THEN 1 ELSE 0 END AD_ALL 
                        ,CASE WHEN DOC_GROUP = ''POLST'' and three_year_ad_polst = 1 THEN 1 ELSE 0 END POLST_THREE 
                        ,CASE WHEN DOC_GROUP  = ''AD'' and three_year_ad_polst = 1 THEN 1 ELSE 0 END AD_THREE 
                FROM (SELECT distinct ap.pat_id 
                                ,ap.doc_info_id 
                                ,ap.SCAN_FILE 
                                ,ap.DOC_GROUP 
                                ,ap.three_year_ad_polst 
                        FROM ' || p_adpolst_table ||'          ap ) 
                ) 
            GROUP BY PAT_ID 
    ) 
 ) R
 ON(COH.PAT_ID = R.PAT_ID) 
 WHEN MATCHED THEN 
 UPDATE SET  
 coh.AD_ALL = r.AD_ALL 
 ,coh.AD_THREE = r.AD_THREE 
 ,coh.POLST_ALL = r.POLST_ALL 
 ,coh.POLST_THREE = r.POLST_THREE 
 ,coh.UPDATE_DATE = SYSDATE ';

EXECUTE IMMEDIATE q1;
    commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where AD_ALL = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria AD_ALL = 1');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where AD_THREE = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria AD_THREE = 1');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where POLST_ALL = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria POLST_ALL = 1');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where POLST_THREE = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria POLST_THREE = 1');
      commit;      

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end P_ACP_ADPOLST_update;


-------------------------------------------------
-- Calculate Last date for AD/POLST
-------------------------------------------------
procedure P_ACP_ADPOLST_date(p_cohort_table in varchar2, p_adpolst_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ADPOLST_date';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
 q1 :=  'MERGE INTO ' || p_cohort_table ||' coh 
USING( 
        SELECT DISTINCT PAT_ID 
                    ,MAX(MOST_RECENT_AD) AS MOST_RECENT_AD 
                    ,MAX(MOST_RECENT_POLST) AS MOST_RECENT_POLST 
        FROM ( 
            select distinct  
            pat_id 
            ,case when doc_group = ''AD'' THEN MOST_RECENT ELSE NULL END MOST_RECENT_AD 
            ,case when doc_group = ''POLST'' THEN MOST_RECENT ELSE NULL END MOST_RECENT_POLST 
            from ( 
                    SELECT  
                    PAT_ID 
                    ,MAX(doc_recv_time) OVER (PARTITION BY PAT_ID,DOC_GROUP) AS MOST_RECENT 
                    ,DOC_GROUP 
                    FROM ' || p_adpolst_table || ') 
            ) 
        GROUP BY PAT_ID) r 
ON (coh.pat_id = r.pat_id  ) 
when matched then UPDATE SET 
coh.MOST_RECENT_AD = r.MOST_RECENT_AD 
,coh.MOST_RECENT_POLST = r.MOST_RECENT_POLST 
,coh.UPDATE_DATE = SYSDATE ';

EXECUTE IMMEDIATE q1;
    commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where MOST_RECENT_AD IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'MOST_RECENT_AD IS NOT NULL');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where MOST_RECENT_POLST IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'MOST_RECENT_POLST IS NOT NULL');
      commit;
      
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end P_ACP_ADPOLST_date;


-------------------------------------------------
-- Merge the last date for AD/POLST to use when calculating patients with a
-- > 3 years old documents
-------------------------------------------------
procedure P_ACP_ADPOLST_merge(p_cohort_table in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_ADPOLST_merge';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

   q1 := 'MERGE INTO ' || p_cohort_table || ' coh  
     USING (SELECT PAT_ID 
            ,CASE WHEN AD_ALL + POLST_ALL >= 1 THEN 1 ELSE 0 END AD_POLST_ALL
            ,CASE WHEN AD_THREE + POLST_THREE >= 1 THEN 1 ELSE 0 END AD_POLST_THREE
            ,CASE WHEN coh.MOST_RECENT_AD is not null 
                        and  coh.MOST_RECENT_POLST is not null 
                        and  coh.MOST_RECENT_AD >= coh.MOST_RECENT_POLST 
                    THEN coh.MOST_RECENT_AD 
                WHEN coh.MOST_RECENT_AD is not null 
                        and  coh.MOST_RECENT_POLST is not null 
                        and  coh.MOST_RECENT_POLST > coh.MOST_RECENT_AD 
                    THEN coh.MOST_RECENT_POLST 
                WHEN coh.MOST_RECENT_AD is not null 
                        and  coh.MOST_RECENT_POLST is null 
                    THEN coh.MOST_RECENT_AD 
                WHEN coh.MOST_RECENT_POLST is not null 
                        and  coh.MOST_RECENT_AD is null  
                    THEN coh.MOST_RECENT_POLST                        
                ELSE coh.MOST_RECENT_POLST 
                END LAST_AD_POLST 
FROM ' || p_cohort_table || ' COH)r 
ON (coh.pat_id = r.pat_id  )
WHEN MATCHED THEN  
UPDATE SET 
coh.LAST_AD_POLST = r.LAST_AD_POLST, 
coh.AD_POLST_ALL = r.AD_POLST_ALL, 
coh.AD_POLST_THREE = r.AD_POLST_THREE
,coh.UPDATE_DATE = SYSDATE ';
EXECUTE IMMEDIATE q1;
    commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where AD_POLST_ALL = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'AD_POLST_ALL = 1');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where AD_POLST_THREE = 1';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'AD_POLST_THREE = 1');
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where LAST_AD_POLST IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'LAST_AD_POLST IS NOT NULL');
      commit;

      
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end P_ACP_ADPOLST_merge;


-------------------------------------------------
-- Calculate clinic based on the last encounter wiht the PCP
-------------------------------------------------
procedure P_ACP_loc_last_pcp(p_cohort_table in varchar2, p_driver_dept in varchar2, p_driver_appt_type in varchar2, p_driver_appt_status in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_loc_last_pcp';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'MERGE INTO ' || p_cohort_table  || ' coh 
USING ( 
SELECT DISTINCT PAT_ID 
        ,LOC_ID 
FROM (SELECT DISTINCT PAT_ID 
        ,LOC_ID 
        ,rank() over( 
                    partition by pat_id  
                    order by pat_id, contact_date, checkout_time desc 
                    ) ranking 
    FROM (SELECT distinct coh.PAT_ID 
                    ,enc.PAT_ENC_CSN_ID 
                    ,enc.EFFECTIVE_DATE_DT as contact_date 
                    ,enc.checkout_time 
                    ,coh.CUR_PCP_PROV_ID  
                    ,enc.VISIT_PROV_ID 
                    ,case when coh.CUR_PCP_PROV_ID =  enc.VISIT_PROV_ID then 1 else 0 end pcp_visit_yn 
                    ,enc.department_id 
                    ,loc.loc_id 
            FROM ' || p_cohort_table  || '         coh 
            join pat_enc                enc ON coh.PAT_ID = enc.PAT_ID 
            JOIN ' || p_driver_dept || '       dep on enc.DEPARTMENT_ID = dep.department_id 
            left join clarity_dep dep2 on dep.department_id = dep2.department_id 
            left join clarity_loc loc on dep2.rev_loc_id = loc.loc_id 
            join ' || p_driver_appt_type || '      apt on enc.APPT_PRC_ID = apt.prc_id 
            where   
--                    TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 1 
--                    AND 
                    --modification introduced on 10/05/20 
                    --if the patients is not selected or not alive
                    -- there is no need to calculate their clinic assignment
                     coh.selected = 1 and coh.deceased_yn is null 
                    and enc.effective_date_dt between sysdate - 366 and sysdate  
                    and enc.enc_type_c in ( 101    --Office visit
                    , 91    --Home Care Visit
                    ,70 -- Telephone
                    ,76 -- Telemedicine
                    ) 
                    and apt.USED_FOR_CLINIC_ASSIGNMENT_YN = 1 
                    and (enc.appt_status_c is not null and enc.appt_status_c not in (SELECT APPT_STATUS_C 
                                                                                            FROM ' || p_driver_appt_status || '
                                                                                            WHERE APPT_CAT = ''exclude'' )
                )
            ) 
    WHERE 
        pcp_visit_yn = 1 
        --add exclusion for emergency depts 
        and department_id not in (      --Exclude Emergency Care 
                                    ''70011''       --	SMBP WILSHIRE UC 
                                        ,''80008''        --	SMBP MARINA DL REY UC 
                                        --Exclude 1223 16th street 3100 
                                        ,''70232''            --	GERI SM 3100 
                                        --Exclude SMBP 1090 
                                        ,''70216''            --SMBP 10TH FL 1090   
                                        --exclude WW COMP HLTH STE 525 
                                        ,''60155''            --	IM CHP MP1 525 
                                        --WLV EAST WEST CENTER 
                                        ,''80044''            --	IM EAST WEST MED WLV 
                                        ,''80106''            --	PET CT IMG WESTLAKE  
                                        --UCLA Health Torrance Specialty Care 
                                        ,''80273''            --	EAST WEST TORR STE 302 
                                ) 
    ) 
WHERE    ranking = 1 
)r 
ON 
(COH.PAT_ID = R.PAT_ID) 
WHEN MATCHED THEN 
UPDATE SET coh.CLINIC_LAST_PCP = r.LOC_ID'; 

EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CLINIC_LAST_PCP IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Calculate CLINIC_LAST_PCP for clinic assignment');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_loc_last_pcp;

-------------------------------------------------
-- Calculate clinic based on the clinic wiht the most Primary Care  visits
-------------------------------------------------
PROCEDURE P_ACP_LOC_MOST_VISITS(p_cohort_table in varchar2, p_driver_dept in varchar2, p_driver_appt_type in varchar2, p_driver_appt_status in varchar2) as
 q1 varchar2(4000);


  v_procname varchar2(100) := 'P_ACP_LOC_MOST_VISITS';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
 q1 := 'MERGE INTO ' || p_cohort_table  || ' coh 
USING ( 
SELECT DISTINCT PAT_ID
        ,LOC_ID
FROM (SELECT DISTINCT PAT_ID
        ,LOC_ID
        ,rank() over(
                    partition by pat_id 
                    order by pat_id, ENC_COUNT desc, last_visit DESC,PCP_VISIT_YN desc, checkout_time desc 
                    ) ranking
--,MAX(contact_date) OVER (PARTITION BY pat_id, LOC_ID) AS last_visit
FROM (SELECT coh.PAT_ID
            ,loc.LOC_ID
            ,case when coh.CUR_PCP_PROV_ID =  enc.VISIT_PROV_ID then 1 else 0 end pcp_visit_yn 
            ,max(enc.effective_date_dt) over (partition by coh.pat_id, loc.LOC_ID) as last_visit
            ,count(enc.pat_enc_csn_id) over (partition by coh.pat_id, loc.LOC_ID) as ENC_COUNT 
            ,COALESCE(enc.checkout_time,enc.checkin_time) as checkout_time 
            FROM ' || p_cohort_table  || '         coh 
            join pat_enc                enc ON coh.PAT_ID = enc.PAT_ID 
            JOIN ' || p_driver_dept || '       dep on enc.DEPARTMENT_ID = dep.department_id 
            left join clarity_dep dep2 on dep.department_id = dep2.department_id 
            left join clarity_loc loc on dep2.rev_loc_id = loc.loc_id 
            join ' || p_driver_appt_type || '      apt on enc.APPT_PRC_ID = apt.prc_id 
            where  
--                    TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 1 
--                    AND 
                    --modification introduced on 10/05/20 
                    --if the patients is not selected or not alive
                    -- there is no need to calculate their clinic assignment
                     coh.selected = 1  and coh.deceased_yn is null 
                    and enc.effective_date_dt between sysdate - 366 and sysdate  
                    and enc.enc_type_c IN ( 101    --Office visit
                    , 91    --Home Care Visit
                    ,70 -- Telephone
                    ,76 -- Telemedicine
                    ) 
                    and apt.USED_FOR_CLINIC_ASSIGNMENT_YN = 1 
                    and (enc.appt_status_c is not null and enc.appt_status_c not in (SELECT APPT_STATUS_C 
                                                                                            FROM ' || p_driver_appt_status || '
                                                                                            WHERE APPT_CAT = ''exclude'' )
                        and enc.department_id not in (      --Exclude Emergency Care 
                                    ''70011''       --	SMBP WILSHIRE UC 
                                        ,''80008''        --	SMBP MARINA DL REY UC 
                                        --Exclude 1223 16th street 3100 
                                        ,''70232''            --	GERI SM 3100 
                                        --Exclude SMBP 1090 
                                        ,''70216''            --SMBP 10TH FL 1090   
                                        --exclude WW COMP HLTH STE 525 
                                        ,''60155''            --	IM CHP MP1 525 
                                        --WLV EAST WEST CENTER 
                                        ,''80044''            --	IM EAST WEST MED WLV 
                                        ,''80106''            --	PET CT IMG WESTLAKE  
                                        --UCLA Health Torrance Specialty Care 
                                        ,''80273''            --	EAST WEST TORR STE 302 
                                ) 
                )
            ) 
    ) 
WHERE    ranking = 1 
)r 
ON 
(COH.PAT_ID = R.PAT_ID) 
WHEN MATCHED THEN 
UPDATE SET coh.clinic_most_visits = r.LOC_ID'; 

EXECUTE IMMEDIATE q1;
 commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where clinic_most_visits IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Calculate clinic_most_visits for clinic assignment');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
        end P_ACP_LOC_MOST_VISITS;

-------------------------------------------------
-- Calculate clinic based on the clinic of Primary Care visit
-------------------------------------------------
procedure P_ACP_loc_last_visit(p_cohort_table in varchar2, p_driver_dept in varchar2, p_driver_appt_type in varchar2, p_driver_appt_status in varchar2) as
 q1 varchar2(4000);
  v_procname varchar2(100) := 'P_ACP_loc_last_visit';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'MERGE INTO ' || p_cohort_table  || ' coh 
USING ( 
SELECT DISTINCT PAT_ID 
        ,LOC_ID 
FROM (SELECT DISTINCT PAT_ID 
        ,LOC_ID 
        ,rank() over( 
                    partition by pat_id  
                    order by pat_id, contact_date desc,  checkout_time desc 
                    ) ranking 
    FROM (SELECT distinct coh.PAT_ID 
                    ,enc.PAT_ENC_CSN_ID 
                    ,enc.EFFECTIVE_DATE_DT as contact_date 
                    ,checkout_time 
                    ,coh.CUR_PCP_PROV_ID  
                    ,enc.VISIT_PROV_ID 
                    ,case when coh.CUR_PCP_PROV_ID =  enc.VISIT_PROV_ID then 1 else 0 end pcp_visit_yn 
                    ,enc.department_id 
                    ,loc.loc_id 
            FROM ' || p_cohort_table  || '         coh 
            join pat_enc                enc ON coh.PAT_ID = enc.PAT_ID 
            JOIN ' || p_driver_dept || '       dep on enc.DEPARTMENT_ID = dep.department_id 
            left join clarity_dep dep2 on dep.department_id = dep2.department_id 
            left join clarity_loc loc on dep2.rev_loc_id = loc.loc_id 
            join ' || p_driver_appt_type || '      apt on enc.APPT_PRC_ID = apt.prc_id 
            where  
--                    TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 2
--                    AND 
                    --modification introduced on 10/05/20 
                    --if the patients is not selected or not alive
                    -- there is no need to calculate their clinic assignment
                     coh.selected = 1  and coh.deceased_yn is null 
                    and  enc.effective_date_dt between sysdate - 366 and sysdate  
                    and enc.enc_type_c IN ( 101    --Office visit
                    , 91    --Home Care Visit
                    ,70 -- Telephone
                    ,76 -- Telemedicine
                    ) 
                    and apt.USED_FOR_CLINIC_ASSIGNMENT_YN = 1 
                    and (enc.appt_status_c is not null and enc.appt_status_c not in (SELECT APPT_STATUS_C 
                                                                                            FROM ' || p_driver_appt_status || '
                                                                                            WHERE APPT_CAT = ''exclude'' )
                )
            ) 
    WHERE 
        --add exclusion for emergency depts 
        department_id not in (      --Exclude Emergency Care 
                                    ''70011''       --	SMBP WILSHIRE UC 
                                        ,''80008''        --	SMBP MARINA DL REY UC 
                                        --Exclude 1223 16th street 3100 
                                        ,''70232''            --	GERI SM 3100 
                                        --Exclude SMBP 1090 
                                        ,''70216''            --SMBP 10TH FL 1090   
                                        --exclude WW COMP HLTH STE 525 
                                        ,''60155''            --	IM CHP MP1 525 
                                        --WLV EAST WEST CENTER 
                                        ,''80044''            --	IM EAST WEST MED WLV 
                                        ,''80106''            --	PET CT IMG WESTLAKE  
                                        --UCLA Health Torrance Specialty Care 
                                        ,''80273''            --	EAST WEST TORR STE 302 
                                ) 
    ) 
WHERE    ranking = 1 
)r 
ON 
(COH.PAT_ID = R.PAT_ID) 
WHEN MATCHED THEN 
UPDATE SET coh.CLINIC_LAST_VISIT = r.LOC_ID'; 

EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CLINIC_LAST_VISIT IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Calculate CLINIC_LAST_VISIT for clinic assignment');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);

end P_ACP_loc_last_visit;




-------------------------------------------------
-- Update Clinic assigned field
-------------------------------------------------
PROCEDURE P_ACP_CLINIC(p_cohort_table in varchar2) as
 q1 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_CLINIC';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'update ' || p_cohort_table  || ' 
    set clinic_id = COALESCE(CLINIC_LAST_PCP,CLINIC_MOST_VISITS,CLINIC_LAST_VISIT) 
    WHERE 
--          TRUNC(SYSDATE) - TRUNC(CREATION_DATE) BETWEEN  0 AND 2 
--          and 
          COALESCE(CLINIC_LAST_PCP,CLINIC_MOST_VISITS,CLINIC_LAST_VISIT) is not null
    ';
EXECUTE IMMEDIATE q1;
 commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where CLINIC_ID IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Assign clinic_id');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_CLINIC; 

--PROCEDURE P_ACP_COORDINATOR(p_cohort_table in varchar2, p_driver_table in varchar2) as
-- q1 varchar2(4000);
--  v_procname varchar2(100) := 'P_ACP_COORDINATOR';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--
-- q1 := 'merge into ' || p_cohort_table  || '  coh 
--USING 
--(SELECT distinct coh.pat_id 
--            ,gr.coordinator_id 
--FROM ' || p_cohort_table  || '  coh 
--join ' || p_driver_table || '  gr on coh.clinic_id = gr.clinic_id 
--WHERE 
--TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 3 AND  
--GR.clinic_id NOT IN (
--    -- clinics with +1 CCC
--6016
--,7083
--,6017 
--,7000)
--) r
--on
--(coh.pat_id = r.pat_id)
--when matched THEN
--update SET coh.coordinator_id = r.coordinator_id';
--EXECUTE IMMEDIATE q1;
--commit;
--      --- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where COORDINATOR_ID IS NOT NULL';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Assign coordinator_id');
--      commit;
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--end P_ACP_COORDINATOR;


-------------------------------------------------
-- Assign intervention arm based on the clinic/arm relationship
-------------------------------------------------
PROCEDURE P_ACP_INTERV_ARM_ASSIGNMENT(p_cohort_table in varchar2, p_driver_table in varchar2) as
 q1 varchar2(4000);
v_procname varchar2(100) := 'P_ACP_INTERV_ARM_ASSIGNMENT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
 q1 := 'MERGE INTO ' || p_cohort_table || ' coh 
USING ( 
SELECT DISTINCT coh.pat_id  
               ,ran.arm 
  FROM ' || p_cohort_table || '       coh 
  JOIN ' || p_driver_table || '       ran on coh.clinic_id = ran.clinic_id 
--  WHERE 
--  TRUNC(SYSDATE) - TRUNC(coh.CREATION_DATE) BETWEEN  0 AND 3 
  ) r 
  ON  
  (coh.pat_Id = r.pat_id) 
  WHEN MATCHED THEN 
  UPDATE SET coh.ARM = r.arm';
 EXECUTE IMMEDIATE q1;
 commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where ARM IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Assign intervention arm');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end P_ACP_INTERV_ARM_ASSIGNMENT;

-------------------------------------------------
-- Assign study_id to be used in the research cohort
-------------------------------------------------
procedure p_assign_study_id(p_cohort_table in varchar2, p_study_table in varchar2) as
 q1 varchar2(4000);
v_procname varchar2(100) := 'p_assign_study_id';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'INSERT INTO ' || p_study_table || '(pat_id,ADDED_DATE) 
        SELECT DISTINCT coh.PAT_ID, CURRENT_DATE 
        FROM ' || p_cohort_table || '                     coh 
        LEFT JOIN ' || p_study_table || '       st ON coh.pat_id = st.pat_id 
        WHERE coh.SELECTED = 1 
                AND coh.EXCLUSION_REASON is null 
                and coh.prime is null 
                AND st.pat_id is null';
 EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT_STUDY_ID';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT_STUDY_ID', sysdate, v_audit_cnt,v_procname,'Assign study_id');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_assign_study_id;

-------------------------------------------------
-- Drop table for clean up 
-------------------------------------------------        
procedure p_acp_clean_up(p_table_name in varchar2) as
 q1 varchar2(4000);
v_procname varchar2(100) := 'p_acp_clean_up';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'DROP TABLE ' || p_table_name  ||
        ' PURGE';
 EXECUTE IMMEDIATE q1;
commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
        end p_acp_clean_up;       

-------------------------------------------------
-- Truncate table for clean up 
-------------------------------------------------        
procedure p_acp_truncate_tbl(p_table_name in varchar2) as
 q1 varchar2(4000);
v_procname varchar2(100) := 'p_acp_truncate_tbl';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'TRUNCATE TABLE ' || p_table_name ;
 EXECUTE IMMEDIATE q1;
commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
        end p_acp_truncate_tbl;       

-------------------------------------------------
-- Delete arm 1, adm 2, and arm 3 (with ACP outreach completed) from RWB weekly report table 
-------------------------------------------------
procedure p_truncate_rwb_weekly(p_cohort_table in varchar2, p_rwb_table in varchar2, p_tbl_outreach_temp in varchar2
,p_tbl_outreach_hx in varchar2) as
 q1 varchar2(4000);
 q2 varchar2(4000);
 q3 varchar2(4000);
 q4 varchar2(4000);
 
  v_procname varchar2(100) := 'p_truncate_rwb_weekly';
     v_audit_cnt number;
   v_qry_str varchar2(6000);
   v_qry_str2 varchar2(6000);
   v_audit_cnt2 NUMBER; 

  BEGIN

v_qry_str := 'select COUNT(*) from XDR_ACP_RWB_WEEKLY';
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
 q1 := '
 delete from ' || p_rwb_table ||  '
  where
  arm in (1,2)';
  EXECUTE IMMEDIATE q1;
   commit;
   
 q2:= 'INSERT INTO ' || p_tbl_outreach_temp || '
 select distinct rwb.pat_id
 ,ENC.PAT_ENC_CSN_ID
    ,sed.hlv_id
    ,enc.enc_close_time
    ,sed.CUR_VALUE_DATETIME
    ,enc.ENC_CLOSED_USER_ID
    ,enc.enc_close_time - sed.CUR_VALUE_DATETIME AS DIF
    ,TO_BINARY_DOUBLE(ROUND(ABS(enc.enc_close_time - sed.CUR_VALUE_DATETIME),2)) AS DIF_ABS  
    ,SYSDATE AS CREATION_DATE
    from smrtdta_elem_data          sed
            join ' || p_rwb_table || ' rwb on sed.PAT_LINK_ID = rwb.pat_id
            join  SMRTDTA_ELEM_VALUE        sev on sed.hlv_id = sev.hlv_id
            JOIN pat_enc                    enc on rwb.pat_id = enc.pat_id
                                                  and enc.enc_type_c = 69     --Outreach
                                                  and enc.enc_closed_yn = ''Y''
                                                  and TO_BINARY_DOUBLE(ROUND(ABS(enc.enc_close_time - sed.CUR_VALUE_DATETIME),2)) between 0 and 0.25 
                                                   and enc.ENC_CLOSED_USER_ID = sed.CUR_VALUE_USER_ID  
            where sed.CUR_SOURCE_LQF_ID = 992
                  and sed.ELEMENT_ID = ''UCLATEAM#339''
                  and sed.CUR_VALUE_DATETIME > ''02/17/2020''';
  EXECUTE IMMEDIATE q2;
   commit;
   
 q3 := '
 delete from ' || p_rwb_table ||  '
  where
  arm = 3
  and
  pat_id in 
            (
            select distinct pat_id
            from  ' || p_tbl_outreach_temp || ' 
  )';

EXECUTE IMMEDIATE q3;
   commit;

 q4 := 'INSERT INTO  ' || p_tbl_outreach_hx ||  '
 select * from  ' || p_tbl_outreach_temp ;

EXECUTE IMMEDIATE q4;
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    
    v_qry_str2 := 'select COUNT(*) from XDR_ACP_RWB_WEEKLY';

      EXECUTE IMMEDIATE v_qry_str2 INTO v_audit_cnt2;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY', sysdate, v_audit_cnt - v_audit_cnt2,v_procname,'Truncate weekly intervention table');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_truncate_rwb_weekly; 

-------------------------------------------------
-- Pull completed ACP smart forms
-------------------------------------------------
Procedure P_Save_Smartforms(P_Tbl_Smartform In Varchar2 , P_Tbl_Outreach_Temp In Varchar2) As
 q1 Varchar2(4000);
 q2 varchar2(4000);
 
  v_procname varchar2(100) := 'p_save_smartforms';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1:= 'INSERT INTO ' || p_tbl_smartform || '  
 select distinct coh.pat_id 
       ,sed.ELEMENT_ID
       ,case 
            when sed.ELEMENT_ID = ''UCLATEAM#329'' then ''AD < 3 YEARS OLD IN CHART''
            when sed.ELEMENT_ID = ''UCLATEAM#330'' then ''POLST < 3 YEARS OLD IN CHART''
            when sed.ELEMENT_ID = ''UCLATEAM#331'' then ''AD < 3 YEARS OLD AT HOME COMPLETED''
            when sed.ELEMENT_ID = ''UCLATEAM#332'' then ''AD > 3 YEARS OLD ON FILE STILL VALID''
            when sed.ELEMENT_ID = ''UCLATEAM#333'' then ''WILLING TO USE PREPARE FOR YOUR CARE WEBSITE''
            when sed.ELEMENT_ID = ''UCLATEAM#336'' then ''INTRODUCING AD COMPLETION WITH PATIENT''
            when sed.ELEMENT_ID = ''UCLATEAM#338'' then ''IS PATIENT WILLING TO USE PREPARE FOR YOUR CARE WEBSITE''
            when sed.ELEMENT_ID = ''UCLATEAM#339'' then ''ACP OUTREACH TIMESTAMP''
            when sed.ELEMENT_ID = ''UCLATEAM#341'' then ''PATIENT WILL COMPLETE AD AND SUBMIT VIA:''
            when sed.ELEMENT_ID = ''UCLATEAM#342'' then ''PATIENT WILL COMPLETE AD AND SUBMIT VIA OTHER COMMENT:''
            when sed.ELEMENT_ID = ''UCLATEAM#344'' then ''AD < 3 YEARS OLD AT HOME COMPLETED OTHER COMMENT''
            when sed.ELEMENT_ID = ''UCLATEAM#345'' then ''PATIENT NOT READY TO PROCEED WITH AD. CCC TO FOLLOW UP ON:''
            when sed.ELEMENT_ID = ''UCLATEAM#346'' then ''POLST''
            when sed.ELEMENT_ID = ''UCLATEAM#347'' then ''PATIENT REFUSE''
            when sed.ELEMENT_ID = ''UCLATEAM#348'' then ''OUTREACH COMMENTS''
            else ''OTHER''
        end smart_element_name 
       ,sed.CUR_VALUE_DATETIME 
       ,sed.UPDATE_DATE 
       ,sed.REC_ARCHIVED_YN 
       ,sed.CUR_VAL_UTC_DTTM 
       ,sed.HLV_ID 
       ,sev.line 
       ,sev.smrtdta_elem_value 
       ,sysdate as creation_date 
       ,sed.CUR_VALUE_USER_ID as user_id 
       ,emp.name as user_name 
from ' || p_tbl_outreach_temp || '     coh 
join clarity.smrtdta_elem_data          sed on coh.pat_id = sed.PAT_LINK_ID 
join  clarity.SMRTDTA_ELEM_VALUE        sev on sed.hlv_id = sev.hlv_id 
left join clarity.clarity_emp           emp on sed.CUR_VALUE_USER_ID = emp.USER_ID 
where sed.CUR_SOURCE_LQF_ID = 992';
  EXECUTE IMMEDIATE q1;
   commit;

 Q2:= 'UPDATE ctsi_research.Xdr_Acp_Cohort
SET intervention_exclusion_yn = 1
WHERE Pat_Id IN (SELECT DISTINCT Coh.Pat_Id 
FROM ctsi_research.Xdr_Acp_Cohort coh 
JOIN ctsi_research.Xdr_Acp_Smartforms sm ON coh.pat_id = sm.pat_id         
                                                  And Sm.Smart_Element_Name Like ''%3 YEARS OLD ON FILE STILL VALID'' 
                                                  And Sm.Smrtdta_Elem_Value = ''Yes'')';
      --- update ACP_ETL_LOG with record count prior to truncate 
    
     v_qry_str := 'select COUNT(distinct pat_id ) from ' || p_tbl_smartform;
      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
   
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_SMARTFORMS', sysdate, v_audit_cnt,v_procname,'Record smart form records');
      commit;
      
      Execute Immediate q2;
   Commit;
         --- update ACP_ETL_LOG with record count prior to truncate 


    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_save_smartforms; 


-------------------------------------------------
-- Identify patients that fit the criteria for an intervention
-- and populate the table feeding the Reporting Workbench report 
-------------------------------------------------
procedure p_trigger_intervention_arm_1_2(p_cohort_table in varchar2, p_rwb_table in varchar2, p_rwb_hx_table in varchar2, p_appt_type_table in varchar2, p_clinic_table in varchar2
 ,P_Dept_Driver_Table In Varchar2) As
 q1 varchar2(4500);
 q2 varchar2(4000);
v_procname varchar2(100) := 'p_trigger_intervention_arm_1_2';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'insert into ' || p_rwb_table || '  
(PAT_ID
,ARM
,CLINIC_ID
,CUR_PCP_PROV_ID
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE 
,MAIL_LETTER_EST_DT) 
SELECT DISTINCT 
PAT_ID 
,ARM 
,CLINIC_ID 
,CUR_PCP_PROV_ID 
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE 
,RWB_SUBMISSION_DATE + 7 
FROM ( 
SELECT pat_id 
                ,arm 
                ,loc_id AS CLINIC_ID 
                ,cur_pcp_prov_id 
                ,first_appointment AS NEXT_APPT_DATE 
                ,DEPARTMENT_ID AS NEXT_APPT_DEPARTMENT_ID 
                ,LOC_ID AS NEXT_APPT_LOC_ID 
                ,pat_enc_csn_id AS NEXT_APPT_PAT_ENC_CSN_ID 
                ,PROV_ID AS NEXT_APPT_PROVIDER_ID 
                ,current_date   AS RWB_SUBMISSION_DATE 
FROM (SELECT  x.*  
        FROM (select distinct coh.pat_id 
                    ,coh.cur_pcp_prov_id 
                    ,coh.arm 
                    ,appt.pat_enc_csn_id 
                    ,appt.contact_date 
                    ,MIN(appt.contact_date) OVER (PARTITION BY appt.pat_id) AS first_appointment 
                    ,APPT.PROV_ID 
                    ,APPT.DEPARTMENT_ID 
                    ,APPT.LOC_ID 
                from ' || p_cohort_table || '                        coh 
                JOIN v_sched_appt                          appt ON coh.pat_id = appt.pat_id 
                -- appointment type match
                JOIN ' || p_appt_type_table || '           prcdrv ON appt.prc_id = prcdrv.prc_id and prcdrv.INTERVENTION_TRIGGER = 1 
                -- PC clinic
                JOIN ' || p_clinic_table || '               rd ON APPT.LOC_ID = rd.clinic_id 
                -- PC Department
                JOIN ' ||  p_dept_driver_table || '           depdrv ON APPT.DEPARTMENT_ID = depdrv.department_id  
                -- and patient is not lockout (not intervention in the last 6 months) : use intervention DATE 
                LEFT JOIN ' || p_rwb_hx_table || '             hx   ON COH.PAT_ID = HX.PAT_ID 
                                                                    AND (current_date ) - trunc(hx.RWB_SUBMISSION_DATE) < 180  
                LEFT JOIN pat_enc                               enc ON appt.pat_enc_csn_id = enc.pat_enc_csn_id 
                where 
                    --Patient is seriously ill
                    coh.selected = 1 
                    --Smart_Element_Name like ''%3 YEARS OLD ON FILE STILL VALID''  YES
                    and intervention_exclusion_yn is null
                    -- and patient is not decesased (restricted is allowed for QI) 
                    AND coh.DECEASED_YN is null
                    --appointment completed 
                    AND appt.appt_status_name = ''Scheduled'' 
                    --  and patient has a PC appointment in their assigned clinic 
                    AND appt.loc_id = coh.clinic_id               
                    -- Patient without a AD/POLST in the last three years 
                    and (coh.ad_polst_all = 0 OR ((current_DATe - 1)  - coh.LAST_AD_POLST) > 365.25 *3) 
                    -- Appointment time threshold modified on 10/01/20 from 21-27
                    and (trunc(appt.CONTACT_DATE) - (current_date - 1) ) between 14 and 20 
                    --and patient is not lockout (not intervention in the last 6 months) 
                    AND hx.PAT_ID is  null 
                    -- Patient has not opted out 
                    AND coh.opt_out IS NULL 
                    and coh.arm in (1,2)
                    --Exclude one clinic without go live date
                    and rd.go_live_date is not null
                    -- Exclude patients who had a previous intervention and declared to have a valid AD even if + 3 yo
                    and coh.INTERVENTION_EXCLUSION_YN is null
            ) x 
            WHERE 
                x.contact_date = first_appointment)
                )';
                
 EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_rwb_table || ' where arm in (3)';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY', sysdate, v_audit_cnt,v_procname,'Interventions triggered arms (1,2)');
      commit;

--  Load weekly interventions into the historic table
 q2 := 'INSERT INTO ' || p_rwb_hx_table || ' 
        SELECT * FROM ' || p_rwb_table || ' where arm in (1,2)';
                
 EXECUTE IMMEDIATE q2;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_rwb_hx_table || ' where arm in (1,2)';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_HX', sysdate, v_audit_cnt,v_procname,'Historic interventions count arms (1,2)');
      commit;
      
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_trigger_intervention_arm_1_2;

-------------------------------------------------
-- Assign study_id to be used in the research cohort
-------------------------------------------------
--procedure p_remove_arm_3_interventions(p_cohort_table in varchar2, p_wrb_table in varchar2, p_wrb_hx_table in varchar2) as
-- q1 varchar2(4000);
--v_procname varchar2(100) := 'p_remove_arm_3_interventions';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--
-- q1 := 'DELETE FROM ' || p_wrb_table || ' WHERE pat_id IN ( 
--        SELECT DISTINCT coh.PAT_ID, CURRENT_DATE 
--        FROM ' || p_wrb_table || '                     rwb 
--        LEFT JOIN ' || p_study_table || '       st ON coh.pat_id = st.pat_id 
--        WHERE rwb.arm = 3 
--                ';
-- EXECUTE IMMEDIATE q1;
--commit;
--      --- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT_STUDY_ID';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT_STUDY_ID', sysdate, v_audit_cnt,v_procname,'Assign study_id');
--      commit;
--
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--end p_remove_arm_3_interventions;



-------------------------------------------------
-- Identify patients that fit the criteria for an intervention
-- and populate the table feeding the Reporting Workbench report 
-------------------------------------------------
procedure p_trigger_intervention_arm_3(p_cohort_table in varchar2, p_rwb_table in varchar2, p_rwb_hx_table in varchar2, p_appt_type_table in varchar2, p_clinic_table in varchar2
 ,p_dept_driver_table in varchar2) as
 q1 varchar2(4500);
 q2 varchar2(4000);
v_procname varchar2(100) := 'p_trigger_intervention_arm_3';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'insert into ' || p_rwb_table || '  
(PAT_ID
,ARM
,CLINIC_ID
,CUR_PCP_PROV_ID
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE 
,MAIL_LETTER_EST_DT) 
SELECT DISTINCT 
PAT_ID 
,ARM 
,CLINIC_ID 
,CUR_PCP_PROV_ID 
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE 
,RWB_SUBMISSION_DATE + 7
FROM ( 
SELECT pat_id 
                ,arm 
                ,loc_id AS CLINIC_ID 
                ,cur_pcp_prov_id 
                ,first_appointment AS NEXT_APPT_DATE 
                ,DEPARTMENT_ID AS NEXT_APPT_DEPARTMENT_ID 
                ,LOC_ID AS NEXT_APPT_LOC_ID 
                ,pat_enc_csn_id AS NEXT_APPT_PAT_ENC_CSN_ID 
                ,PROV_ID AS NEXT_APPT_PROVIDER_ID 
                ,current_date  AS RWB_SUBMISSION_DATE 
FROM (SELECT  x.*  
        FROM (select distinct coh.pat_id 
                    ,coh.cur_pcp_prov_id 
                    ,coh.arm 
                    ,appt.pat_enc_csn_id 
                    ,appt.contact_date 
                    ,MIN(appt.contact_date) OVER (PARTITION BY appt.pat_id) AS first_appointment 
                    ,APPT.PROV_ID 
                    ,APPT.DEPARTMENT_ID 
                    ,APPT.LOC_ID 
                from ' || p_cohort_table || '                        coh 
                JOIN v_sched_appt                          appt ON coh.pat_id = appt.pat_id 
                -- and patient is not lockout (not intervention in the last 6 months) : use intervention or appointment DATE 
                LEFT JOIN ' || p_rwb_hx_table || '             hx   ON COH.PAT_ID = HX.PAT_ID 
                                                                    AND (current_date  )- trunc(hx.RWB_SUBMISSION_DATE) < 180  
--                left join XDR_ACP_COHORT_PRIME        prm on coh.pat_id = prm.pat_id and prm.prime = 1 
                --LEFT JOIN pat_enc                               enc ON appt.pat_enc_csn_id = enc.pat_enc_csn_id 
                JOIN ' || p_appt_type_table || '           prcdrv ON appt.prc_id = prcdrv.prc_id and prcdrv.INTERVENTION_TRIGGER = 1 
                JOIN ' || p_clinic_table || '               rd ON APPT.LOC_ID = rd.clinic_id 
                -- PC Department appointment
                JOIN ' ||  p_dept_driver_table || '           depdrv ON APPT.DEPARTMENT_ID = depdrv.department_id   
                where 
					--If patient is selected  
                    coh.selected = 1 
                    -- and patient is not decesased (restricted is allowed for QI) 
                    AND coh.DECEASED_YN is null
                    --appointment completed 
                    --Smart_Element_Name like ''%3 YEARS OLD ON FILE STILL VALID''  YES
                    and intervention_exclusion_yn is null 
                    AND appt.appt_status_name = ''Scheduled'' 
                    --  and patient has a PC appointment in the designated clinic 
                    AND appt.loc_id = coh.clinic_id               
                    -- Patient without a AD/POLST in the last three years 
                    and (coh.ad_polst_all = 0 OR ((current_DATe + 1 ) - coh.LAST_AD_POLST) > 365.25 *3) 
                    -- Appointment time threshold: modified on 10/01/20 from 21-27
                    and (trunc(appt.CONTACT_DATE) - (current_date + 1) ) between 14 and 20 
                    --and patient is not lockout (not intervention in the last 6 months) 
                    AND hx.PAT_ID is  null 
                    -- Patient has not opted out 
                    AND coh.opt_out IS NULL 
                    and coh.arm in (3)
                    and rd.go_live_date is not null
                    -- Exclude patients who had a previous intervention and declared to have a valid AD even if > 3 yo
                    and coh.INTERVENTION_EXCLUSION_YN is null
            ) x 
            WHERE 
                x.contact_date = first_appointment)
                )';
                
 EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    V_Qry_Str := 'select COUNT(*) from ' || P_Rwb_Table || ' rwb  
    LEFT JOIN ' || p_rwb_hx_table || ' hx On Rwb.next_appt_Pat_Enc_Csn_Id = Hx.next_appt_Pat_Enc_Csn_Id 
    where Rwb.Arm In (3)  
    And Hx.Next_Appt_Pat_Enc_Csn_Id Is Null 
    and rwb.bulk_yn is null';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY', sysdate, v_audit_cnt,v_procname,'Interventions triggered arm (3)');
      commit;

--  Load weekly interventions into the historic table
 q2 := 'INSERT INTO ' || p_rwb_hx_table || ' 
        SELECT rwb.* FROM ' || p_rwb_table || ' rwb  
        LEFT JOIN ' || p_rwb_hx_table || ' hx On Rwb.next_appt_Pat_Enc_Csn_Id = Hx.next_appt_Pat_Enc_Csn_Id 
        where Rwb.Bulk_Yn Is Null 
        And Hx.Next_Appt_Pat_Enc_Csn_Id Is Null 
        and trunc(rwb.rwb_submission_date) > (current_date - 2)';
                
 EXECUTE IMMEDIATE q2;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_rwb_hx_table || '   
                  where arm in (3)';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_HX', sysdate, v_audit_cnt,v_procname,'Historic interventions count arms (3)');
      commit;
      
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_trigger_intervention_arm_3;

-------------------------------------------------
-- Record clinic/arm grey dot assignment (at the time of patient identification)
-------------------------------------------------
procedure p_acp_grey_dot(p_cohort_table in varchar2, p_dot_history_table in varchar2, p_study_id_table in varchar2) as
 q1 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_GREY_DOT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'insert into ' || p_dot_history_table || ' (pat_id,study_id,CREATION_DATE,CUR_PCP_PROV_ID,CLINIC_ID,arm,data_point,LAST_AD_POLST) 
 select distinct coh.pat_id 
          ,st.study_id 
          ,sysdate as CREATION_DATE 
          ,coh.CUR_PCP_PROV_ID as CUR_PCP_PROV_ID 
          ,coh.CLINIC_ID as CLINIC_ID 
          ,coh.arm as arm 
          ,''Cohort_discovery_grey_dot'' as data_point 
          ,coh.LAST_AD_POLST 
          ,coh,AD_POLST_THREE   
          ,coh.AD_POLST_ALL 
FROM ' || p_cohort_table || '         coh 
LEFT JOIN ' || p_dot_history_table || '  hx on coh.pat_id = hx.pat_id 
                            and hx.data_point = ''Cohort_discovery_grey_dot'' 
LEFT JOIN ' || p_study_id_table || '   st on coh.pat_id = st.pat_id                            
WHERE hx.pat_id is null 
AND coh.selected = 1 
AND coh.DECEASED_YN is null 
AND coh.opt_out is null';

EXECUTE IMMEDIATE q1;
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_PCP_CLINIC_ARM_HX where data_point = ''Cohort_discovery_grey_dot''';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PCP_CLINIC_ARM_HX', sysdate, v_audit_cnt,v_procname,'Cohort_discovery_grey_dot');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_grey_dot; 


-------------------------------------------------
-- Record clinic/arm orange dot assignment (at the time of clinic going live)
-------------------------------------------------
procedure p_acp_orange_dot(p_cohort_table in varchar2, p_dot_history_table in varchar2,p_clinic_table in varchar2, p_study_id_table in varchar2) as
 q1 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_ORANGE_DOT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'insert into ' || p_dot_history_table || ' (pat_id,study_id,CREATION_DATE,CUR_PCP_PROV_ID,CLINIC_ID,arm,data_point,LAST_AD_POLST,AD_POLST_THREE,AD_POLST_ALL) 
 select distinct coh.pat_id 
          ,st.study_id 
          ,sysdate as CREATION_DATE 
          ,coh.CUR_PCP_PROV_ID as CUR_PCP_PROV_ID 
          ,coh.CLINIC_ID as CLINIC_ID 
          ,coh.arm as arm 
          ,''Clinic_goes_live_orange_dot'' as data_point 
          ,coh.LAST_AD_POLST 
          ,coh.AD_POLST_THREE   
          ,coh.AD_POLST_ALL 
FROM ' || p_cohort_table || '         coh 
JOIN ' || p_clinic_table || '        arm on coh.clinic_id = arm.clinic_id and  trunc(current_date) = trunc(arm.go_live_date - 1) 
LEFT JOIN ' || p_dot_history_table || '  hx on coh.pat_id = hx.pat_id 
                            and hx.data_point = ''Clinic_goes_live_orange_dot'' 
LEFT JOIN ' || p_study_id_table || '   st on coh.pat_id = st.pat_id                            
WHERE hx.pat_id is null 
AND coh.selected = 1 
AND coh.DECEASED_YN is null';

EXECUTE IMMEDIATE q1;
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_PCP_CLINIC_ARM_HX where data_point = ''Clinic_goes_live_orange_dot''';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PCP_CLINIC_ARM_HX', sysdate, v_audit_cnt,v_procname,'Clinic_goes_live_orange_dot');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_orange_dot; 

-------------------------------------------------
-- Record clinic/arm red dot assignment (at the time of the intervention)
-------------------------------------------------
procedure p_acp_red_dot(p_cohort_table in varchar2, p_dot_history_table in varchar2,p_intervention_table in varchar2, p_study_id_table in varchar2) as
 q1 varchar2(4000);

  v_procname varchar2(100) := 'P_ACP_RED_DOT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN

 q1 := 'insert into ' || p_dot_history_table || ' (pat_id,study_id,CREATION_DATE,CUR_PCP_PROV_ID,CLINIC_ID,arm,data_point,LAST_AD_POLST,AD_POLST_THREE , AD_POLST_ALL ) 
 select distinct intrv.pat_id 
          ,st.study_id 
          ,sysdate as CREATION_DATE 
          ,coh.CUR_PCP_PROV_ID as CUR_PCP_PROV_ID 
          ,coh.CLINIC_ID as CLINIC_ID 
          ,coh.arm as arm 
          ,''Intervention_red_dot'' as data_point 
          ,coh.LAST_AD_POLST 
          ,coh.AD_POLST_THREE   
          ,coh.AD_POLST_ALL 
FROM ' || p_intervention_table || '     intrv 
JOIN ' || p_cohort_table || '         coh on intrv.pat_id = coh.pat_id 
LEFT JOIN ' || p_study_id_table || '   st on intrv.pat_id = st.pat_id                            
where trunc(intrv.rwb_submission_date) > current_date - 2';

EXECUTE IMMEDIATE q1;
   commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_PCP_CLINIC_ARM_HX where data_point = ''Intervention_red_dot''';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_PCP_CLINIC_ARM_HX', sysdate, v_audit_cnt,v_procname,'Intervention_red_dot');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_red_dot; 


-------------------------------------------------
-- Flag patients in the PRIME program that already received an intervention
-------------------------------------------------
--procedure p_acp_flagged_prime(p_cohort_table in varchar2, p_driver_table in varchar2) as
-- q1 varchar2(4000);
--
--  v_procname varchar2(100) := 'P_ACP_FLAGGED_PRIME';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--
-- q1 := 'UPDATE ' || p_cohort_table  || ' 
--        SET PRIME = 1 
--        WHERE PAT_ID 
--                  in ( 
--                  SELECT DISTINCT PAT_ID 
--                  FROM '|| p_driver_table || '
--                   WHERE PRIME = 1 )';
--
--EXECUTE IMMEDIATE q1;
--   commit;
--      --- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where PRIME = 1';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Criteria PRIME = 1');
--      commit;
--
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--end p_acp_flagged_prime; 

-------------------------------------------------
-- Create an intervention timetable for intervention simulation
-------------------------------------------------
procedure p_simulation_intervention_drv
--(p_return       OUT VARCHAR2) 
as

		q1 varchar2(4000);
		q2 varchar2(4000);
		v_procname varchar2(100) := 'p_simulation_intervention_drv';
		v_p_cohort_table  varchar2(150) := 'CTSI_RESEARCH.XDR_ACP_COHORT';
		v_p_wrb_table  varchar2(150) := 'CTSI_RESEARCH.XDR_ACP_RWB_WEEKLY_SIMU';
		v_p_wrb_hx_table  varchar2(150) := 'CTSI_RESEARCH.XDR_ACP_RWB_WEEKLY_HX_SIMU';
		v_p_appt_type_table  varchar2(150) := 'CTSI_RESEARCH.XDR_ACP_APPT_TYPE';
		v_p_clinic_table  varchar2(150) :='CTSI_RESEARCH.XDR_ACP_RANDOMIZATION';
		v_rwb_submission_date_report varchar2(30) ;
		v_rwb_submission_date_appt varchar2(30) ;
		v_go_live_date varchar2(30) ;
		v_audit_cnt number;
		v_qry_str varchar2(6000);
    v_return varchar2(1000);
--    v_step number(38,0);

    CURSOR comor_csr IS
			    	SELECT DISTINCT  
      RWB_SUBMISSION_DATE_appt as od
			,to_char(RWB_SUBMISSION_DATE_appt,'mm/dd/yyyy') as RWB_SUBMISSION_DATE_appt
      ,to_char(RWB_SUBMISSION_DATE_report,'mm/dd/yyyy') as RWB_SUBMISSION_DATE_report
      ,to_char(GO_LIVE_DATE,'mm/dd/yyyy') as GO_LIVE_DATE
			
      ,STEP
		FROM XDR_ACP_SIMULATION_DATES
    order by 1;
    
  BEGIN
 FOR comor_rec IN comor_csr
      LOOP

		  if comor_rec.STEP = 1 THEN
			v_rwb_submission_date_appt := comor_rec.RWB_SUBMISSION_DATE_appt;
			v_rwb_submission_date_report := comor_rec.RWB_SUBMISSION_DATE_report;
			v_go_live_date := comor_rec.GO_LIVE_DATE;
      v_return := 'Report date: ' || v_rwb_submission_date_report || ' - Appt date: ' || v_rwb_submission_date_appt || ' - Go Live date: ' || v_go_live_date;
--      v_step := comor_rec.STEP;
--      PRINT_ERROR('p_simulation_intervention', comor_rec.STEP, v_return);
			
      p_simulation_intervention(v_p_cohort_table,v_p_wrb_table,v_p_wrb_hx_table,v_p_appt_type_table,v_p_clinic_table,v_rwb_submission_date_report,v_rwb_submission_date_appt,v_go_live_date);
		  end if;
		  if comor_rec.STEP = 2 THEN
			v_rwb_submission_date_appt := comor_rec.RWB_SUBMISSION_DATE_appt;
			v_rwb_submission_date_report := comor_rec.RWB_SUBMISSION_DATE_report;
			v_go_live_date := comor_rec.GO_LIVE_DATE;
      v_return := 'Report date: ' || v_rwb_submission_date_report || ' - Appt date: ' || v_rwb_submission_date_appt || ' - Go Live date: ' || v_go_live_date;
--      v_step := comor_rec.STEP;
--      PRINT_ERROR('p_simulation_intervention', comor_rec.STEP, v_return);
			p_simulation_intervention_bat(v_p_cohort_table,v_p_wrb_table,v_p_wrb_hx_table,v_p_appt_type_table,v_p_clinic_table,v_rwb_submission_date_report,v_rwb_submission_date_appt,v_go_live_date);
		  end if;
	  end loop;
     
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
--        v_return := 'ERROR IN p1_load_lz_clarity_pt_dx_score: ' || sqlerrm;
--        dbms_output.put_line (p_return);
		
end p_simulation_intervention_drv;		
	  
-------------------------------------------------
-- Identify patients that fit the criteria for an intervention
-- and populate the table feeding the Reporting Workbench report 
-- SIMULATION
-------------------------------------------------    
procedure p_simulation_intervention(p_cohort_table in varchar2, p_wrb_table in varchar2, p_wrb_hx_table in varchar2, p_appt_type_table in varchar2, p_clinic_table in varchar2
,p_dept_driver_table in varchar2
,RWB_SUBMISSION_DATE_report in varchar2
,RWB_SUBMISSION_DATE_appt in varchar2
,GO_LIVE_DATE in varchar2
) as
  q0 varchar2(4000);
  q1 varchar2(4000);
  q2 varchar2(4000);
  v_procname varchar2(100) := 'p_simulation_intervention';
  v_audit_cnt number;
  v_qry_str varchar2(6000);
  v_return varchar2(1000);

  BEGIN
--  Truncate weekly interventions table
 q0 := 'TRUNCATE TABLE ' || p_wrb_table ;            
 EXECUTE IMMEDIATE q0;
commit;


 q1 := 'insert into ' || p_wrb_table || '  
(PAT_ID
,ARM
,CLINIC_ID
,CUR_PCP_PROV_ID
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE) 
SELECT 
PAT_ID 
,ARM 
,CLINIC_ID 
,CUR_PCP_PROV_ID 
,NEXT_APPT_DATE 
,NEXT_APPT_DEPARTMENT_ID 
,NEXT_APPT_LOC_ID 
,NEXT_APPT_PAT_ENC_CSN_ID 
,NEXT_APPT_PROVIDER_ID 
,RWB_SUBMISSION_DATE 
FROM ( 
SELECT pat_id 
                ,arm 
                ,loc_id AS CLINIC_ID 
                ,cur_pcp_prov_id 
                ,first_appointment AS NEXT_APPT_DATE 
                ,DEPARTMENT_ID AS NEXT_APPT_DEPARTMENT_ID 
                ,LOC_ID AS NEXT_APPT_LOC_ID 
                ,pat_enc_csn_id AS NEXT_APPT_PAT_ENC_CSN_ID 
                ,PROV_ID AS NEXT_APPT_PROVIDER_ID 
                ,to_date(''' || RWB_SUBMISSION_DATE_report || ''',''mm/dd/yyyy'') AS RWB_SUBMISSION_DATE 
FROM (SELECT  x.*  
        FROM (select distinct coh.pat_id 
                    ,coh.cur_pcp_prov_id 
                    ,coh.arm 
                    ,appt.pat_enc_csn_id 
                    ,appt.contact_date 
                    ,MIN(appt.contact_date) OVER (PARTITION BY appt.pat_id) AS first_appointment 
                    ,APPT.PROV_ID 
                    ,APPT.DEPARTMENT_ID 
                    ,APPT.LOC_ID 
                from ' || p_cohort_table || '                        coh 
                JOIN js_xdr_walling_appt3                          appt ON coh.pat_id = appt.pat_id 
                -- and patient is not lockout (not intervention in the last 6 months) : use intervention or appointment DATE 
                LEFT JOIN ' || p_wrb_hx_table || '             hx   ON COH.PAT_ID = HX.PAT_ID 
                                                                    AND to_date(''' || RWB_SUBMISSION_DATE_appt || ''',''mm/dd/yyyy'') - trunc(hx.RWB_SUBMISSION_DATE) < 180  
--                left join XDR_ACP_COHORT_PRIME        prm on coh.pat_id = prm.pat_id and prm.prime = 1 
                LEFT JOIN pat_enc                               enc ON appt.pat_enc_csn_id = enc.pat_enc_csn_id 
                LEFT JOIN ' || p_appt_type_table || '           prcdrv ON enc.appt_prc_id = prcdrv.prc_id and prcdrv.INTERVENTION_TRIGGER = 1 
                LEFT JOIN ' || p_clinic_table || '               rd ON APPT.LOC_ID = rd.clinic_id AND trunc(rd.go_live_date) > to_date(''12/15/2018'',''mm/dd/yyyy'') - 1 
                -- PC Department appointment
                LEFT JOIN ' ||  p_dept_driver_table || '           depdrv ON APPT.DEPARTMENT_ID = depdrv.department_id  
                --left join v_cube_d_provider prv on APPT.PROV_ID = prv.provider_id 
                where 
					--If patient is selected  
                    coh.selected = 1 
                    -- and patient is not decesased (restricted is allowed for QI) 
                    AND (coh.EXCLUDED is null OR  coh.EXCLUSION_REASON <> ''patient deceased'') 
--                    AND coh.EXCLUDED is null and coh.DECEASED_YN is null 
                    --appointment completed 
                    AND appt.appt_status_name = ''Completed'' 
					--  and patient has a PC appointment in the designated clinic 
					AND appt.loc_id = coh.clinic_id               
					-- Patient without a AD/POLST in the last three years 
                    and (coh.ad_polst_all = 0 OR (to_date(''' || RWB_SUBMISSION_DATE_appt || ''',''mm/dd/yyyy'') - coh.LAST_AD_POLST) > 365.25 *3) 
                    -- Appointment time threshold 
                    and trunc(appt.CONTACT_DATE) -to_date(''' || RWB_SUBMISSION_DATE_appt || ''',''mm/dd/yyyy'') between 21 and 27 
                    --and patient is not lockout (not intervention in the last 6 months) 
                    AND hx.PAT_ID is  null 
                    -- patients not already in PRIME 
                    and coh.prime is null 
                    -- exclude resources type providers 
                    --and prv.provider_type = ''Physician'' 
                    and trunc(rd.go_live_date) < to_date('''|| GO_LIVE_DATE || ''',''mm/dd/yyyy'') 
            ) x 
            WHERE 
                x.contact_date = first_appointment)
                )';    
 EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_wrb_table;
          v_return := 'Interventions triggered: ' || RWB_SUBMISSION_DATE_report || ' - Appt date: ' || RWB_SUBMISSION_DATE_appt || ' - Go Live date: ' || GO_LIVE_DATE;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_SIMU', sysdate, v_audit_cnt,v_procname,v_return);
      commit;

--  Load weekly interventions into the historic table
 q2 := 'INSERT INTO ' || p_wrb_hx_table || ' 
        SELECT * FROM ' || p_wrb_table ;
                
 EXECUTE IMMEDIATE q2;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_wrb_hx_table;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_HX_SIMU', sysdate, v_audit_cnt,v_procname,'Historic interventions count');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_simulation_intervention;

-------------------------------------------------
-- Identify patients that fit the criteria for an intervention
-- and populate the table feeding the Reporting Workbench report 
-- Batch intervention for patients that have not received an intervention in the last 6 months
-------------------------------------------------    
procedure p_simulation_intervention_bat(p_cohort_table in varchar2, p_wrb_table in varchar2, p_wrb_hx_table in varchar2, p_appt_type_table in varchar2, p_clinic_table in varchar2
,RWB_SUBMISSION_DATE_report in varchar2
,RWB_SUBMISSION_DATE_appt in varchar2
,GO_LIVE_DATE in varchar2
) as

	 q0 varchar2(4000);
	 q1 varchar2(4000);
	 q2 varchar2(4000);
	 v_procname varchar2(100) := 'p_simulation_intervention_bat';
	 v_audit_cnt number;
	 v_qry_str varchar2(6000);
   v_return varchar2(1000);
		
	BEGIN	
--  Truncate weekly interventions table
 q0 := 'TRUNCATE TABLE ' || p_wrb_table ;            
 EXECUTE IMMEDIATE q0;
commit;

q1 := 'insert into ' || p_wrb_table || ' 
(PAT_ID
,ARM
,CLINIC_ID
,RWB_SUBMISSION_DATE) 
select distinct coh.pat_id 
                    ,coh.arm 
                    ,COH.CLINIC_ID
					,to_date(''' || RWB_SUBMISSION_DATE_report || ''') as RWB_SUBMISSION_DATE  
                from XDR_ACP_COHORT                    coh  
                -- and patient is not lockout (not intervention in the last 6 months) : use intervention or appointment DATE 
                LEFT JOIN XDR_ACP_RWB_WEEKLY_hx_SIMU           hx   ON COH.PAT_ID = HX.PAT_ID 
                                                                    AND to_date(''' || RWB_SUBMISSION_DATE_appt || ''') - trunc(hx.RWB_SUBMISSION_DATE) < 180  
LEFT JOIN XDR_ACP_RANDOMIZATION             rd ON COH.CLINIC_ID = rd.clinic_id AND trunc(rd.go_live_date) > to_date(''12/15/2018'',''mm/dd/yyyy'') - 1 																	                                                                    
                where 
					--If patient is selected  
                    coh.selected = 1 
                    -- and patient is not decesased (restricted is allowed for QI) 
                    AND (coh.EXCLUDED is null OR  coh.EXCLUSION_REASON <> ''patient deceased'') 
					-- Patient without a AD/POLST in the last three years 
                    and (coh.ad_polst_all = 0 OR (to_date(''' || RWB_SUBMISSION_DATE_appt || ''') - coh.LAST_AD_POLST) > 365.25 *3) 
                    --and patient is not lockout (not intervention in the last 6 months) 
                    AND hx.PAT_ID is  null 
                    -- patients not already in PRIME 
                    and coh.prime is null 
                    and trunc(rd.go_live_date) < to_date('''|| GO_LIVE_DATE || ''')'  ;

 EXECUTE IMMEDIATE q1;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_wrb_table;
v_return := 'Interventions triggered: ' || RWB_SUBMISSION_DATE_report || ' - Appt date: ' || RWB_SUBMISSION_DATE_appt || ' - Go Live date: ' || GO_LIVE_DATE;
      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_SIMU', sysdate, v_audit_cnt,v_procname,v_return);
      commit;
	  
--  Load weekly interventions into the historic table
 q2 := 'INSERT INTO ' || p_wrb_hx_table || ' 
        SELECT * FROM ' || p_wrb_table ;
                
 EXECUTE IMMEDIATE q2;
commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ' || p_wrb_hx_table;

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_RWB_WEEKLY_HX_SIMU', sysdate, v_audit_cnt,v_procname,'Historic simulation interventions count');
      commit;

    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
		
end p_simulation_intervention_bat;

----------------------------------------
--Update Opt Out flag
----------------------------------------
procedure p_acp_optout(p_cohort_table in varchar2, p_patient_table in varchar2, p_optout_table in varchar2) as
 q1 varchar2(4000);
 q2 varchar2(4000);
v_procname varchar2(100) := 'P_ACP_OPTOUT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  BEGIN
  -- Make sure that the leading 0 on MRN is captured
 q1 := 'UPDATE ' || p_optout_table || '
        SET "MRN" = ''0'' || "MRN" 
        WHERE LENGTH("MRN") = 6';
 EXECUTE IMMEDIATE q1;
 commit;

-- Update Opt Out flag
 q2 := ' MERGE INTO ' || p_cohort_table || '  coh 
USING (SELECT DISTINCT coh.PAT_ID 
FROM ' || p_cohort_table || '   coh 
JOIN ' || p_patient_table || '  pat on coh.pat_id = pat."PAT_ID" 
JOIN ' || p_optout_table || '   opt on pat.pat_mrn_id = opt."MRN"  
) r
ON (coh.pat_id = r.pat_id)
WHEN MATCHED THEN UPDATE SET
coh.opt_out = 1';
 EXECUTE IMMEDIATE q2;
 commit;
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT where OPT_OUT IS NOT NULL';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Opt outs');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_optout;

procedure p_acp_race as
 q1 varchar2(4000);
 q2 varchar2(4000);
v_procname varchar2(100) := 'P_ACP_OPTOUT';
     v_audit_cnt number;
   v_qry_str varchar2(6000);

  
  begin
        v_qry_str := 'select COUNT(*) from CTSI_RESEARCH.xdr_acp_race';
    
    EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
    
-------------------------------------
-- Update temp table with all race record for each patitne in report table
-------------------------------------
insert into  xdr_acp_race 
SELECT distinct p.pat_id,
        p.patient_race_c,
        zcr.name as name
        FROM patient_race p
      join xdr_acp_redcap_report_final r on p.pat_id = r.pat_id
        LEFT JOIN zc_patient_race zcr on p.patient_race_c = zcr.patient_race_c
        WHERE p.patient_race_c is not null;
commit;


-------------------------------------
-- Update race values to capture myultiple race scenarios
-------------------------------------        
UPDATE xdr_acp_redcap_report_final p  
        SET (mapped_race_c, mapped_race_name) = 
        (
SELECT DISTINCT mapped_race_c, mapped_race_name FROM 
         (SELECT s1.pat_id, 900 AS mapped_race_c, 'Multiple Races' AS mapped_race_name       
            FROM (SELECT DISTINCT lz.pat_id
                    FROM (SELECT DISTINCT pr.pat_id
                                         ,zc.rollup_race_c    AS patient_race_c
                                         ,zc.rollup_race_name AS "NAME"
                            FROM ctsi_research.xdr_acp_race pr
                            JOIN i2b2.race_rollup             zc ON pr.patient_race_c = zc.patient_race_c
                         ) lz
                    WHERE lz.patient_race_c NOT IN (7,8)                                      --7=PATIENT REFUSED, 8=UNKNOWN
                    GROUP BY lz.pat_id HAVING count(*) > 1) s1
          UNION ALL
          SELECT s1.pat_id, 7 AS mapped_race_c, 'Patient Refused' AS mapped_race_name         --PATREF AND UNKNOWN ONLY, USE PATREF (E.G. 7,8)
            FROM (SELECT DISTINCT lz.pat_id
                    FROM (SELECT DISTINCT pr.pat_id
                                         ,zc.rollup_race_c    AS patient_race_c
                                         ,zc.rollup_race_name AS "NAME"
                            FROM ctsi_research.xdr_acp_race pr
                            JOIN i2b2.race_rollup             zc ON pr.patient_race_c = zc.patient_race_c
                         ) lz
                    WHERE EXISTS (SELECT DISTINCT lz2.pat_id FROM i2b2.lz_clarity_patient_race lz2 WHERE lz.pat_id = lz2.pat_id AND lz2.patient_race_c = 7)
                      AND EXISTS (SELECT DISTINCT lz2.pat_id FROM i2b2.lz_clarity_patient_race lz2 WHERE lz.pat_id = lz2.pat_id AND lz2.patient_race_c = 8)
                    GROUP BY lz.pat_id HAVING count(*) = 2) s1
          UNION ALL
          SELECT DISTINCT s1.pat_id                                                           --SINGLE ONLY (E.G. ANY SINGLE OCCURRENCE OF RACE)
                         ,zc.rollup_race_c     AS mapped_race_c
                         ,zc.rollup_race_name  AS mapped_race_name 
            FROM (SELECT DISTINCT lz.pat_id
                    FROM (SELECT DISTINCT pr.pat_id
                                         ,zc.rollup_race_c    AS patient_race_c
                                         ,zc.rollup_race_name AS "NAME"
                            FROM ctsi_research.xdr_acp_race pr
                            JOIN i2b2.race_rollup             zc ON pr.patient_race_c = zc.patient_race_c
                         ) lz
                    GROUP BY lz.pat_id HAVING count(*) = 1) s1
            JOIN ctsi_research.xdr_acp_race lz ON s1.pat_id = lz.pat_id
            JOIN i2b2.race_rollup             zc ON lz.patient_race_c = zc.patient_race_c
          UNION ALL 
          SELECT DISTINCT s1.pat_id                                                           --PATREF AND UNKNOWN WITH ANOTHER SINGLE RACE, USE SINGLE RACE (E.G. 1,7,8 or 2,7, 4,14,7)
                         ,zc.rollup_race_c     AS mapped_race_c
                         ,zc.rollup_race_name  AS mapped_race_name 
            FROM (SELECT DISTINCT lz.pat_id
                    FROM (SELECT DISTINCT pr.pat_id
                                         ,zc.rollup_race_c    AS patient_race_c
                                         ,zc.rollup_race_name AS "NAME"
                            FROM ctsi_research.xdr_acp_race pr
                            JOIN i2b2.race_rollup             zc ON pr.patient_race_c = zc.patient_race_c
                         ) lz
                    WHERE lz.patient_race_c NOT IN (7,8)                                      --7=PATIENT REFUSED, 8=UNKNOWN
                    GROUP BY lz.pat_id HAVING count(*) = 1) s1
            JOIN ctsi_research.xdr_acp_race lz ON s1.pat_id = lz.pat_id
            JOIN i2b2.race_rollup             zc ON lz.patient_race_c = zc.patient_race_c
            WHERE lz.patient_race_c NOT IN (7,8) 
         ) x WHERE x.pat_id = p.pat_id
      );        
      commit;

      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from XDR_ACP_redcap_report_final where MAPPED_RACE_NAME is not null';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('p_acp_race', sysdate, v_audit_cnt,v_procname,'Opt outs');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_acp_race;


procedure p_tableau_reporting as
 q1 varchar2(4000);
 q2 varchar2(4000);
v_procname varchar2(100) := 'P_TABLEAU_REPORTING';
     v_audit_cnt number;
   v_qry_str varchar2(6000);
 
  begin
        v_qry_str := 'select COUNT(*) from CTSI_RESEARCH.xdr_acp_tableau';
    
    EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      
    INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS)  values ('xdr_acp_tableau', sysdate, v_audit_cnt,v_procname, 'Tableau report - Post Count');

    execute immediate 'TRUNCATE TABLE ctsi_research.xdr_acp_tableau';
    commit;
    --========================================================
--create process to update baseline_yn
-- Criteria is patients joined clinic before go live date
-- patient currently alive
-- patient died AFTER go-live-date
--write a SP to update this field
--========================================================
UPDATE CTSI_RESEARCH.XDR_ACP_COHORT
SET BASELINE_YN = 0;
commit;
UPDATE CTSI_RESEARCH.XDR_ACP_COHORT
SET BASELINE_YN = 1
WHERE
PAT_ID IN 
(SELECT DISTINCT coh.PAT_ID
FROM CTSI_RESEARCH.XDR_ACP_COHORT   coh
join ctsi_research.xdr_acp_pcp_clinic_arm_hx   hx on coh.pat_id = hx.pat_id
                                    and hx.data_point = 'Clinic_goes_live_orange_dot'
WHERE 
(coh.deceased_yn is null or coh.deceased_yn = 0)
OR
(coh.deceased_yn = 1 and coh.death_date > hx.creation_date)
)
;
commit;



--========================================================
--populate TABLEAU reporting table
--========================================================
insert into  xdr_acp_tableau (STUDY_ID
,PAT_ID
,PATIENT_DEAD_YN
,DEATH_DATE
,LAST_AD_DT
,DATE_GREY
,ARM_GREY
,DATE_ORANGE
,ARM_ORANGE
,DATE_RED
,ARM_RED
,BULK_YN_RED
,DATE_RED2
,ARM_RED2
,BULK_YN_RED2
,RESEARCH_COHORT_YN
,ARM
,LAST_AD_POLST_ORANGE
,CURRENT_PATIENT_YN
,BASELINE_YN
,REDCAP_EVENT_NAME
,CONSENT_MAILED_DT
,CONSENT_RECEIVED_DT
,CONTACT1_DT
,CONTACT1_OUTPUT
,CONTACT2_DT
,CONTACT2_OUTPUT
,CONTACT3_DT
,CONTACT3_OUTPUT
,FIRST_EMAIL_SENT_PCP_DT
,FIRST_MAIL_DT
,GIFT_CARD_MAIL_DT
,HIPAA_DECLINED
,HIPAA_DECLINED_CMT
,HIPAA_MAILED_DT
,HIPAA_RECEIVED_DT
,HIPAA_SENT_YN
,LAST_PATIENT_LOAD
,MRN
,OPTED_OUT_PATIENT_OTHER
,OPTED_OUT_PATIENT_REASON
,OPTED_OUT_PATIENT_REASONS
,OPT_OUT_PAT_DT
,OPT_OUT_PROV_DT
,OPT_OUT_PROV_REASON
,SECOND_EMAIL_SENT_PCP_DT
,SECOND_MAIL_DT
,SURVEY_COMPLETED_YN
,SURVEY_COMPLETED_DT
,INELIGIBLE_INTERVNTN_CALC_YN
,OPTED_OUT_PROVIDER_YN
,FOLLOWUP_HIPAA_RESENT_YN
,SURVEY_COMPLETED_METHOD
,SURVEY_REDCAP_YN
)
select distinct 
st.STUDY_ID
,coh.pat_id
,coh.deceased_yn as PATIENT_DEAD_YN
,coh.death_date as DEATH_DATE
,coh.LAST_AD_POLST as LAST_AD_DT

,grey.creation_date as DATE_GREY
,grey.arm as ARM_GREY
,orng.CREATION_DATE as DATE_ORANGE
,orng.ARM as ARM_ORANGE
,red.DATE_RED
,red.ARM_RED
,red.BULK_YN_RED
,case when red.date_red <> red.date_red2 then red.date_red2
					else null 
      end  date_red2
,case when red.date_red <> red.date_red2 then red.arm_red2 
          else null
    end arm_red2
,case when red.date_red <> red.date_red2 then red.bulk_yn_red2 
          else null
  end bulk_yn_red2
,coh.FINAL_COHORT_YN as RESEARCH_COHORT_YN
--,CURRENT_PATIENT_YN

--baseline
,coh.ARM
,orng.LAST_AD_POLST as LAST_AD_POLST_ORANGE
--alive patients assgined to a clinic that is live
			,case when (
				  (rd.go_live_date is not null and (coh.DECEASED_YN is null or COH.DECEASED_YN = 0))
				  or orng.creation_date is not null  
				  or(rd.go_live_date is not null and coh.DECEASED_YN = 1
					  and coh.death_date  > rd.go_live_date)
			) then 1 else 0 end current_patient_yn
      

--redcap REPORT
,coh.BASELINE_YN
,rc.redcap_event_name
,rc.CONSENT_MAILED_DT
,rc.CONSENT_RECEIVED_DT
,rc.CONTACT1_DT
,rc.CONTACT1_OUTPUT
,rc.CONTACT2_DT
,rc.CONTACT2_OUTPUT
,rc.CONTACT3_DT
,rc.CONTACT3_OUTPUT
,rc.FIRST_EMAIL_SENT_PCP_DT
,rc.FIRST_MAIL_DT
,rc.GIFT_CARD_MAIL_DT
,rc.HIPAA_DECLINED
,rc.HIPAA_DECLINED_CMT
,rc.HIPAA_MAILED_DT
,rc.HIPAA_RECEIVED_DT
,rc.HIPAA_SENT_YN
,rc.LAST_PATIENT_LOAD
,rc.MRN
,rc.OPTED_OUT_PATIENT_OTHER
,rc.OPTED_OUT_PATIENT_REASON
,rc.OPTED_OUT_PATIENT_REASONS
,rc.OPT_OUT_PAT_DT
,rc.OPT_OUT_PROV_DT
,rc.OPT_OUT_PROV_REASON
,rc.SECOND_EMAIL_SENT_PCP_DT
,rc.SECOND_MAIL_DT
,rc.SURVEY_COMPLETED_YN
,rc.SURVEY_COMPLETED_DT
,rc.INELIGIBLE_INTERVNTN_CALC_YN
,rc.OPTED_OUT_PROVIDER_YN
,rc.FOLLOWUP_HIPAA_RESENT_YN
,rc.SURVEY_COMPLETED_METHOD
,rc.SURVEY_REDCAP_YN
--=========
--pending to add 2/17/21
--========================
--,rc.language
--,rc.opted_out_patient_yn

from ctsi_research.xdr_acp_cohort                   coh
left join ctsi_research.xdr_acp_randomization       rd on coh.clinic_id = rd.clinic_id
left join ctsi_research.xdr_acp_cohort_study_id     st on coh.pat_id = st.pat_id
--add orange dot data
left join ctsi_research.xdr_acp_pcp_clinic_arm_hx   orng on coh.pat_id = orng.pat_id
                                                        and orng.data_point = 'Clinic_goes_live_orange_dot'
--add grey dot data
left join ctsi_research.xdr_acp_pcp_clinic_arm_hx   grey on coh.pat_id = grey.pat_id
                                                        and grey.data_point = 'Cohort_discovery_grey_dot'
--add redcap data                                                        
left join ctsi_research.XDR_ACP_REDCAP_REPORT_TEMP2   rc on st.STUDY_ID = rc.STUDY_ID
-- add intervention red dots (1) and (2)
			left join (
					  select hx.*
					  from (
						  select distinct pat_id
								  ,rwb_submission_date as date_red
								  ,lead(rwb_submission_date,1) over ( partition by pat_id  order by rwb_submission_date)as date_red2
								  ,arm as arm_red
								  ,lead(arm,1) over ( partition by pat_id  order by rwb_submission_date)as arm_red2
								  ,bulk_yn as bulk_yn_red
								  ,lead(bulk_yn,1) over ( partition by pat_id  order by rwb_submission_date)as bulk_yn_red2
								  
						  from ctsi_research.xdr_acp_rwb_weekly_hx )hx
						  left join (   
						  select distinct pat_id,count(*) as ct
										from ctsi_research.xdr_acp_rwb_weekly_hx
										group by pat_id)
						   ctr on hx.pat_id = ctr.pat_id
					  where (ctr.ct = 2 and hx.date_red2 is not null)
					  or ctr.ct = 1
					  ) red on coh.pat_id = red.pat_id
where coh.selected = 1;
commit;

update  ctsi_research.xdr_acp_tableau set current_patient_yn = 1;
commit;

--=====================================================
--Update mychart status and myuchart letter opened for first intervention
--=====================================================
merge into ctsi_research.xdr_acp_tableau tb
using (select distinct 
x.pat_id
,x.mychart_status
from (
select distinct  tb.pat_id
,CASE WHEN lt.pat_id IS NULL THEN 0 ELSE 1 END mychart_status
,lt.LETTER_HNO_ID
,lt.contact_date
,lt.ltr_status_chg_tm
,max(lt.ltr_status_chg_tm) over (partition by tb.pat_id) as last_letter_dt
from ctsi_research.XDR_ACP_tableau    tb
join PAT_ENC_LETTERS   lt on tb.pat_id = lt.pat_id
										  and lt.LETTER_TEMPLATE_ID in (1400000101, 1400000102, 1400000103, 1400000104, 1400000105, 1400000106)
										  and lt.contact_date between  tb.DATE_RED and  tb.DATE_RED  + 5
)x
where
x.ltr_status_chg_tm = last_letter_dt
)r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.mychart_status = r.mychart_status
;
commit;


merge into ctsi_research.xdr_acp_tableau tb
using (select distinct y.pat_id
              ,y.mychart_opened_yn
              ,y.first_letter_read_dt
      from (
          select distinct x.pat_id
              ,x.LETTER_HNO_ID
              ,MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME
              ,CASE WHEN x.LETTER_HNO_ID IS NOT NULL and trunc(MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME) >= trunc(x.contact_date) THEN 1 ELSE 0 END mychart_opened_yn
              ,min(MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME) over (partition by x.pat_id) as first_letter_read_dt
          from (
                select distinct  tb.pat_id
                ,lt.LETTER_HNO_ID
                ,lt.contact_date
                ,lt.ltr_status_chg_tm
                ,max(lt.ltr_status_chg_tm) over (partition by tb.pat_id) as last_letter_dt
                from ctsi_research.XDR_ACP_tableau    tb
                LEFT join PAT_ENC_LETTERS   lt on tb.pat_id = lt.pat_id
                                      and lt.LETTER_TEMPLATE_ID in (1400000101, 1400000102, 1400000103, 1400000104, 1400000105, 1400000106)
                                      and lt.contact_date between  tb.DATE_RED and  tb.DATE_RED  + 5
                )x
          LEFT JOIN MYC_PAT_NOTE_VIEW ON MYC_PAT_NOTE_VIEW.NOTE_ID = x.LETTER_HNO_ID
          where
          x.ltr_status_chg_tm = last_letter_dt
          )y
    where
    y.PATIENT_VIEW_TIME =  first_letter_read_dt
)r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.mychart_opened_yn = r.mychart_opened_yn
;
commit;

--=====================================================
--Update mychart status and myuchart letter opened for second intervention
--=====================================================


merge into ctsi_research.xdr_acp_tableau tb
using (
      select distinct 
      x.pat_id
      ,x.mychart_status2
      from (
            select distinct  tb.pat_id
            ,CASE WHEN lt.pat_id IS NULL THEN 0 ELSE 1 END mychart_status2
            ,lt.LETTER_HNO_ID
            ,lt.contact_date
            ,lt.ltr_status_chg_tm
            ,max(lt.ltr_status_chg_tm) over (partition by tb.pat_id) as last_letter_dt
            from ctsi_research.XDR_ACP_tableau    tb
            join PAT_ENC_LETTERS   lt on tb.pat_id = lt.pat_id
                                  and lt.LETTER_TEMPLATE_ID in (1400000101, 1400000102, 1400000103, 1400000104, 1400000105, 1400000106)
                                  and lt.contact_date between  tb.DATE_RED2 and  tb.DATE_RED2  + 5
            )x
            where
            x.ltr_status_chg_tm = last_letter_dt
      )r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.mychart_status2 = r.mychart_status2
;
commit;

merge into ctsi_research.xdr_acp_tableau tb
using (select distinct y.pat_id
              ,y.mychart_opened2_yn
              ,y.first_letter_read_dt
      from (
          select distinct x.pat_id
              ,x.LETTER_HNO_ID
              ,MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME
              ,CASE WHEN x.LETTER_HNO_ID IS NOT NULL and trunc(MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME) >= trunc(x.contact_date) THEN 1 ELSE 0 END mychart_opened2_yn
              ,min(MYC_PAT_NOTE_VIEW.PATIENT_VIEW_TIME) over (partition by x.pat_id) as first_letter_read_dt
          from (
                select distinct  tb.pat_id
                ,lt.LETTER_HNO_ID
                ,lt.contact_date
                ,lt.ltr_status_chg_tm
                ,max(lt.ltr_status_chg_tm) over (partition by tb.pat_id) as last_letter_dt
                from ctsi_research.XDR_ACP_tableau    tb
                LEFT join PAT_ENC_LETTERS   lt on tb.pat_id = lt.pat_id
                                      and lt.LETTER_TEMPLATE_ID in (1400000101, 1400000102, 1400000103, 1400000104, 1400000105, 1400000106)
                                      and lt.contact_date between  tb.DATE_RED2 and  tb.DATE_RED2  + 5
                )x
          LEFT JOIN MYC_PAT_NOTE_VIEW ON MYC_PAT_NOTE_VIEW.NOTE_ID = x.LETTER_HNO_ID
          where
          x.ltr_status_chg_tm = last_letter_dt
          )y
    where
    y.PATIENT_VIEW_TIME =  first_letter_read_dt
)r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.mychart_opened2_yn = r.mychart_opened2_yn
;
commit;


--=====================================================
-- update CC contact for the first intervention
--=====================================================
merge into ctsi_research.xdr_acp_tableau tb
using (select distinct tb.pat_id
from ctsi_research.xdr_acp_tableau tb
join ctsi_research.XDR_ACP_SMARTFORMS     sm on tb.pat_id = sm.pat_id
where
(sm.CREATION_DATE between  tb.date_red and  tb.date_red2 and tb.date_red2 is not null)
or
(sm.CREATION_DATE >   tb.date_red and tb.date_red2 is  null)
)r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.contacted_by_cc_yn = 1
;
commit;

--=====================================================
-- update CC contact for the second intervention
--=====================================================
merge into ctsi_research.xdr_acp_tableau tb
using (select distinct tb.pat_id
from ctsi_research.xdr_acp_tableau tb
join ctsi_research.XDR_ACP_SMARTFORMS     sm on tb.pat_id = sm.pat_id
where
sm.CREATION_DATE >  tb.date_red2 and tb.date_red2 is not null
)r
on (tb.pat_id = r.pat_id)
when matched then update set
tb.CONTACTED2_BY_CC_YN = 1
;
commit;

  --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ctsi_research.xdr_acp_tableau';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS)  values ('xdr_acp_tableau', sysdate, v_audit_cnt,v_procname, 'Tableau report - Post Count');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);


end p_tableau_reporting;



procedure p_hm_cleanup as
 q1 varchar2(4000);
 q2 varchar2(4000);
v_procname varchar2(100) := 'P_HM_CLEANUP';
     v_audit_cnt number;
   v_qry_str varchar2(6000);
 
  begin
        v_qry_str := 'select COUNT(*) from CTSI_RESEARCH.xdr_acp_hm_temp';
    
    EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
      
    INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS)  values ('xdr_acp_hm_temp', sysdate, v_audit_cnt,v_procname, 'HM clean up - Pre Count');

    execute immediate 'TRUNCATE TABLE ctsi_research.xdr_acp_hm_temp';
    commit;
--=====================================
--pull hm topic status history
--=====================================

insert into ctsi_research.xdr_acp_hm_temp 
select distinct coh.pat_id
,hm.CUR_PCP_PROV_ID
,hm.DEPARTMENT_ID
,hm.EXTRACT_DATE
,hm.HMT_DUE_STATUS_C
,hm.HMT_SEQUENCE
,hm.HM_CURRENT_GUIDE_ID
,hm.IDEAL_RETURN_DT
,hm.QUALIFIED_HMT_ID
,hm.REV_LOC_ID
,hm.TOPIC_NAME
,zst.name as due_status
,MAX(hm.extract_date) OVER (PARTITION BY coh.pat_id) AS latest_measure
from ctsi_research.xdr_acp_rwb_weekly          coh
JOIN F_HM_TREND        hm  ON coh.pat_id = hm.pat_id --and trunc(hm.extract_date) <= coh.date_1 + 90 
        and coh.rwb_submission_date between sysdate - 2 and sysdate-- =  '5422305'
left join ZC_HMT_DUE_STATUS zst ON hm.HMT_DUE_STATUS_C = zst.HMT_DUE_STATUS_C
where 
hm.QUALIFIED_HMT_ID =  9 --Advanced Directive
order by hm.extract_date;


    execute immediate 'TRUNCATE TABLE ctsi_research.xdr_acp_hm';
    commit;
    

--======================================
-- consolidate HM assessment
--======================================
INSERT INTO ctsi_research.xdr_acp_hm  
 select distinct coh.pat_id 
                ,coh.due_status
                ,coh.ideal_return_dt
                ,coh.latest_measure
                ,max(ss.prev_status_max_date) as prev_status_max_date
                ,ss.prev_status
                ,pat.last_ad_polst
from  (select distinct coh.pat_id 
                ,coh.due_status
                ,coh.extract_date
                ,coh.latest_measure
                ,coh.ideal_return_dt
          from XDR_ACP_HM_TEMP coh
          where 
                 coh.extract_date = coh.latest_measure)coh
left join xdr_acp_cohort pat on coh.pat_id = pat.pat_id
left join 
 (
 select x.* from (select distinct pat_id 
                ,due_status as prev_status
                ,extract_date
                ,max(extract_date) over (partition by pat_id,due_status) as prev_status_max_date
          from XDR_ACP_HM_TEMP
                )x
                where x.extract_date = prev_status_max_date
                )  ss on coh.pat_id = ss.pat_id
                        and coh.latest_measure <> ss.prev_status_max_date
group by 
coh.pat_id 
                ,coh.due_status
                ,coh.ideal_return_dt
                ,coh.latest_measure
                ,ss.prev_status
                ,pat.last_ad_polst
order by 1;                       
    
      --- update ACP_ETL_LOG with record count prior to truncate 
    v_qry_str := 'select COUNT(*) from ctsi_research.xdr_acp_hm_temp';

      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('p_hm_cleanup', sysdate, v_audit_cnt,v_procname,'xdr_acp_hm');
      commit;
    EXCEPTION
      WHEN OTHERS THEN 
        v_code := SQLCODE;
        v_errm := substr(sqlerrm, 1, 100);
        PRINT_ERROR(v_procname, v_code, v_errm);
end p_hm_cleanup;


end ACP_COHORT_REFRESH;





--procedure p_acp_remove_restricted(p_cohort_table in varchar2, p_driver_table in varchar2) as
-- q1 varchar2(4000);
-- v_procname varchar2(100) := 'p_acp_remove_restricted';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--
--  q1 := 'DELETE FROM ' || p_cohort_table  ||
--        ' WHERE pat_id IN 
--            (SELECT coh.pat_id  
--                FROM ' || p_cohort_table ||'                   coh 
--                JOIN patient_fyi_flags           flags ON coh.pat_id = flags.patient_id 
--                JOIN ' || p_driver_table || '     st   on flags.PAT_FLAG_TYPE_C = st.PAT_FLAG_TYPE_C 
--                UNION 
--                SELECT coh.pat_id  
--                FROM ' || p_cohort_table ||'                   coh 
--                LEFT JOIN patient_3                         ON coh.pat_id = patient_3.pat_id 
--                WHERE 
--                    patient_3.is_test_pat_yn = ''Y'')';
-- EXECUTE IMMEDIATE q1;
-- commit;
----- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--        INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Delete not already selected restricted patients');
--
--      commit;
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--
--end p_acp_remove_restricted;


--procedure p_acp_remove_deceased(p_cohort_table in varchar2) as
-- q1 varchar2(4000);
-- v_procname varchar2(100) := 'p_acp_remove_deceased';
--     v_audit_cnt number;
--   v_qry_str varchar2(6000);
--
--  BEGIN
--        DBMS_OUTPUT.PUT_LINE('proc name is: ' || v_procname); 
--
-- q1 := 'DELETE FROM ' || p_cohort_table  ||
--        ' WHERE pat_id IN 
--            (SELECT DISTINCT coh.PAT_ID 
--            FROM ' || p_cohort_table  || '     coh 
--            JOIN patient            pat on coh.pat_id = pat.pat_id 
--            WHERE 
--                 i2b2.f_death(pat.pat_id,2,1)  = ''Known Deceased'')';
-- EXECUTE IMMEDIATE q1;
-- commit;
----- update ACP_ETL_LOG with record count prior to truncate 
--    v_qry_str := 'select COUNT(*) from XDR_ACP_COHORT';
--
--      EXECUTE IMMEDIATE v_qry_str INTO v_audit_cnt;
--      INSERT INTO CTSI_RESEARCH.ACP_ETL_LOG(TBL_NAME, LOG_TIME, RECORD_COUNT,PROCEDURE_NAME,COMMENTS) values ('XDR_ACP_COHORT', sysdate, v_audit_cnt,v_procname,'Delete not already selected deceased patients');
--      commit;
--
--    EXCEPTION
--      WHEN OTHERS THEN 
--        v_code := SQLCODE;
--        v_errm := substr(sqlerrm, 1, 100);
--        PRINT_ERROR(v_procname, v_code, v_errm);
--
--end p_acp_remove_deceased;